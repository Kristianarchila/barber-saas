version: '3.9'

services:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MongoDB (Secured with Authentication)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  mongo:
    image: mongo:7
    container_name: barber-mongo
    restart: unless-stopped
    environment:
      # ğŸ” Root admin credentials (change in production!)
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-barber_root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:?MONGO_ROOT_PASSWORD is required}
      MONGO_INITDB_DATABASE: barber-saas
      # Passed to init script for app user creation
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD:?MONGO_APP_PASSWORD is required}
    # ğŸ”’ Port NOT exposed to host â€” only accessible within Docker network
    # Uncomment the next 2 lines ONLY for local development debugging:
    # ports:
    #   - '127.0.0.1:27017:27017'
    volumes:
      - mongo-data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ 'CMD', 'mongosh', '--eval', "db.adminCommand('ping').ok", '--quiet' ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Backend (Node.js / Express)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: barber-backend
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      NODE_ENV: production
      PORT: 4000
      MONGO_URI: mongodb://barber_app:${MONGO_APP_PASSWORD}@mongo:27017/barber-saas?authSource=barber-saas
    ports:
      - '4000:4000'
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - backend-logs:/app/logs
      - backend-backups:/app/backups

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Frontend (Vite build â†’ Nginx)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend:
    build:
      context: ./barberapp-frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /api
        VITE_FRONTEND_URL: http://localhost
    container_name: barber-frontend
    restart: unless-stopped
    ports:
      - '80:80'
    depends_on:
      - backend

volumes:
  mongo-data:
  backend-logs:
  backend-backups:
