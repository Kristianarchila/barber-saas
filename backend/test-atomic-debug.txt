
> backend@1.0.0 test
> jest --runInBand --detectOpenHandles tests/reservas_atomicas.test.js

  console.log
    [dotenv@17.2.3] injecting env (13) from .env -- tip: ÔÜÖ´©Å  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

node.exe : (node:29508) [MONGOOSE] Warning: Duplicate schema index on 
{"reviewToken":1} found. This is often due to declaring an index using both 
"index: true" and "schema.index()". Please remove the duplicate index definition.
En línea: 1 Carácter: 1
+ & "C:\Program Files\nodejs/node.exe" "C:\Program Files\nodejs/node_mo ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: ((node:29508) [M...dex definition.:S 
   tring) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
(Use `node --trace-warnings ...` to show where the warning was created)
(node:29508) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} 
found. This is often due to declaring an index using both "index: true" and 
"schema.index()". Please remove the duplicate index definition.
  console.log
    ­ƒôí [POST] /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar

      at log (src/app.js:93:11)

  console.log
    [Transaction] Started: CreateReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Committed: CreateReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:61:25)

[0mPOST /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar [32m201[0m 52.052 ms - 638[0m
  console.log
    ­ƒôí [POST] /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar

      at log (src/app.js:93:11)

  console.log
    [Transaction] Started: CreateReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Aborted: CreateReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

  console.error
    [Transaction] Failed: CreateReservation {
      error: `E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "10:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }`,
      attempt: 1,
      stack: `MongoServerError: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "10:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }\n` +
        '    at InsertOneOperation.handleOk (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\insert.ts:79:13)\n' +
        '    at tryOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:294:26)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at executeOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:123:12)\n' +
        '    at Collection.insertOne (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\collection.ts:294:12)\n' +
        '    at model.$__save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:398:16)\n' +
        '    at model.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:609:5)\n' +
        '    at C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2722:9\n' +
        '    at async Promise.all (index 0)\n' +
        '    at Function.create (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2707:11)\n' +
        '    at MongoReservaRepository.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:15:16)\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:72:42)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
        '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)'
    }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m [35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CreateReserva.execute (src/application/use-cases/reservas/CreateReserva.js:26:34)
      at Object.<anonymous>.exports.crearReservaBySlug (src/controllers/public.controller.js:140:25)

  console.error
    ­ƒö┤ ERROR: TransactionError: Transaction failed for CreateReservation: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "10:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }
        at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:26:34)
        at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\public.controller.js:140:25) {
      isTransactionError: true,
      originalError: MongoServerError: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "10:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }
          at InsertOneOperation.handleOk (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\operations\insert.ts:79:13)
          at tryOperation (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\operations\execute_operation.ts:294:26)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at executeOperation (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\operations\execute_operation.ts:123:12)
          at Collection.insertOne (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\collection.ts:294:12)
          at model.$__save (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:398:16)
          at model.save (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:609:5)
          at C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:2722:9
          at async Promise.all (index 0)
          at Function.create (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:2707:11)
          at MongoReservaRepository.save (C:\Users\Kristian\Desktop\barber-saas\backend\src\infrastructure\database\mongodb\repositories\MongoReservaRepository.js:15:16)
          at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:72:42)
          at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
          at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:26:34)
          at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\public.controller.js:140:25) {
        errorLabelSet: Set(0) {},
        errorResponse: {
          index: 0,
          code: 11000,
          errmsg: `E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "10:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }`,
          keyPattern: [Object],
          keyValue: [Object]
        },
        index: 0,
        code: 11000,
        keyPattern: { barberoId: 1, fecha: 1, hora: 1, barberiaId: 1 },
        keyValue: {
          barberoId: new ObjectId('698bdcadb65ca3853e73d0a9'),
          fecha: 2026-12-01T00:00:00.000Z,
          hora: '10:00',
          barberiaId: new ObjectId('698bdcadb65ca3853e73d0a7')
        }
      },
      context: { operationName: 'CreateReservation', attempt: 1 },
      timestamp: 2026-02-11T01:34:37.631Z,
      originalStack: `MongoServerError: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "10:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }\n` +
        '    at InsertOneOperation.handleOk (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\insert.ts:79:13)\n' +
        '    at tryOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:294:26)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at executeOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:123:12)\n' +
        '    at Collection.insertOne (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\collection.ts:294:12)\n' +
        '    at model.$__save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:398:16)\n' +
        '    at model.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:609:5)\n' +
        '    at C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2722:9\n' +
        '    at async Promise.all (index 0)\n' +
        '    at Function.create (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2707:11)\n' +
        '    at MongoReservaRepository.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:15:16)\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:72:42)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
        '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)'
    }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"­ƒö┤ ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at Immediate.next (node_modules/router/index.js:291:5)
      at Immediate._onImmediate (node_modules/router/index.js:688:15)

[0mPOST /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar [31m500[0m 53.258 ms - 1164[0m
  console.log
    ­ƒôí [POST] /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar

      at log (src/app.js:93:11)

  console.log
    [Transaction] Started: CreateReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Committed: CreateReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:61:25)

[0mPOST /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar [32m201[0m 25.855 ms - 638[0m
  console.log
    ­ƒôí [POST] /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar

      at log (src/app.js:93:11)

  console.log
    [Transaction] Started: CreateReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Aborted: CreateReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

  console.error
    [Transaction] Failed: CreateReservation {
      error: `E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "11:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }`,
      attempt: 1,
      stack: `MongoServerError: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "11:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }\n` +
        '    at InsertOneOperation.handleOk (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\insert.ts:79:13)\n' +
        '    at tryOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:294:26)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at executeOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:123:12)\n' +
        '    at Collection.insertOne (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\collection.ts:294:12)\n' +
        '    at model.$__save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:398:16)\n' +
        '    at model.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:609:5)\n' +
        '    at C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2722:9\n' +
        '    at async Promise.all (index 0)\n' +
        '    at Function.create (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2707:11)\n' +
        '    at MongoReservaRepository.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:15:16)\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:72:42)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
        '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)'
    }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m [35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CreateReserva.execute (src/application/use-cases/reservas/CreateReserva.js:26:34)
      at Object.<anonymous>.exports.crearReservaBySlug (src/controllers/public.controller.js:140:25)

  console.error
    ­ƒö┤ ERROR: TransactionError: Transaction failed for CreateReservation: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "11:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }
        at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:26:34)
        at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\public.controller.js:140:25) {
      isTransactionError: true,
      originalError: MongoServerError: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "11:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }
          at InsertOneOperation.handleOk (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\operations\insert.ts:79:13)
          at tryOperation (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\operations\execute_operation.ts:294:26)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at executeOperation (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\operations\execute_operation.ts:123:12)
          at Collection.insertOne (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongodb\src\collection.ts:294:12)
          at model.$__save (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:398:16)
          at model.save (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:609:5)
          at C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:2722:9
          at async Promise.all (index 0)
          at Function.create (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:2707:11)
          at MongoReservaRepository.save (C:\Users\Kristian\Desktop\barber-saas\backend\src\infrastructure\database\mongodb\repositories\MongoReservaRepository.js:15:16)
          at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:72:42)
          at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
          at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:26:34)
          at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\public.controller.js:140:25) {
        errorLabelSet: Set(0) {},
        errorResponse: {
          index: 0,
          code: 11000,
          errmsg: `E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "11:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }`,
          keyPattern: [Object],
          keyValue: [Object]
        },
        index: 0,
        code: 11000,
        keyPattern: { barberoId: 1, fecha: 1, hora: 1, barberiaId: 1 },
        keyValue: {
          barberoId: new ObjectId('698bdcadb65ca3853e73d0a9'),
          fecha: 2026-12-01T00:00:00.000Z,
          hora: '11:00',
          barberiaId: new ObjectId('698bdcadb65ca3853e73d0a7')
        }
      },
      context: { operationName: 'CreateReservation', attempt: 1 },
      timestamp: 2026-02-11T01:34:37.740Z,
      originalStack: `MongoServerError: E11000 duplicate key error collection: test.reservas index: unique_reservation_slot dup key: { barberoId: ObjectId('698bdcadb65ca3853e73d0a9'), fecha: new Date(1796083200000), hora: "11:00", barberiaId: ObjectId('698bdcadb65ca3853e73d0a7') }\n` +
        '    at InsertOneOperation.handleOk (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\insert.ts:79:13)\n' +
        '    at tryOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:294:26)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at executeOperation (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\operations\\execute_operation.ts:123:12)\n' +
        '    at Collection.insertOne (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongodb\\src\\collection.ts:294:12)\n' +
        '    at model.$__save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:398:16)\n' +
        '    at model.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:609:5)\n' +
        '    at C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2722:9\n' +
        '    at async Promise.all (index 0)\n' +
        '    at Function.create (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\node_modules\\mongoose\\lib\\model.js:2707:11)\n' +
        '    at MongoReservaRepository.save (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:15:16)\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:72:42)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
        '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)'
    }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"­ƒö┤ ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at Immediate.next (node_modules/router/index.js:291:5)
      at Immediate._onImmediate (node_modules/router/index.js:688:15)

[0mPOST /api/public/barberias/atomic-shop/barberos/698bdcadb65ca3853e73d0a9/reservar [31m500[0m 40.034 ms - 1164[0m
FAIL tests/reservas_atomicas.test.js (5.963 s)
  Pruebas de Atomicidad de Reservas (Anti-Overbooking)
    ├ù No debe permitir dos reservas en el mismo horario (Previene Overbooking) 
(164 ms)
    ├ù Debe permitir reservar si la cita anterior fue CANCELADA (108 ms)

  ÔùÅ Pruebas de Atomicidad de Reservas (Anti-Overbooking) ÔÇ║ No debe permitir 
dos reservas en el mismo horario (Previene Overbooking)

    expect(received).toBe(expected) // Object.is equality

    Expected: 409
    Received: 500

    [0m [90m 79 |[39m
     [90m 80 |[39m         [90m// Debe fallar con el c├│digo 409 Conflict (no 
400)[39m
    [31m[1m>[22m[39m[90m 81 |[39m         
expect(res2[33m.[39mstatus)[33m.[39mtoBe([35m409[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 82 |[39m         
expect(res2[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'Alguien 
acaba de reservar este horario'[39m)[33m;[39m
     [90m 83 |[39m
     [90m 84 |[39m         [90m// Verificar en la BD que solo hay una reserva 
real[39m[0m

      at Object.toBe (tests/reservas_atomicas.test.js:81:29)

  ÔùÅ Pruebas de Atomicidad de Reservas (Anti-Overbooking) ÔÇ║ Debe permitir 
reservar si la cita anterior fue CANCELADA

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 124 |[39m             [33m.[39msend(payload)[33m;[39m
     [90m 125 |[39m
    [31m[1m>[22m[39m[90m 126 |[39m         
expect(res2[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 127 |[39m         expect(res2[33m.[39mbody[33m.[39mreserva[33m.
[39memailCliente)[33m.[39mtoBe([32m'cliente2@test.com'[39m)[33m;[39m
     [90m 128 |[39m     })[33m;[39m
     [90m 129 |[39m })[33m;[39m[0m

      at Object.toBe (tests/reservas_atomicas.test.js:126:29)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 2 total
Snapshots:   0 total
Time:        6.032 s
Ran all test suites matching /tests\\reservas_atomicas.test.js/i.
