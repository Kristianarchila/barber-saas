
> backend@1.0.0 test
> jest --runInBand --detectOpenHandles tests/multi-tenant-security.test.js

  console.log
    [dotenv@17.2.3] injecting env (13) from .env -- tip: ­ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

node.exe : 
(node:18516) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
En línea: 1 Carácter: 
1
+ & "C:\Program Files\
nodejs/node.exe" 
"C:\Program 
Files\nodejs/node_mo 
...
+ ~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~
~~~~~
    + CategoryInfo    
          : NotSpeci  
  fied: ((node:1851   
 6) [M...dex defin    
ition.:String) []    
, RemoteException
    + FullyQualifiedE 
   rrorId : NativeCo  
  mmandError
 
(Use `node 
--trace-warnings ...` 
to show where the 
warning was created)
(node:18516) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"numeroPedido":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:18516) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"expiraEn":1} found. 
This is often due to 
declaring an index 
using both "index: 
true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:18516) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
  console.log
    ­ƒôí [PATCH] /api/reservas/698a8c677ad9824b3cc32cdf/completar

      at log (src/app.js:98:11)

  console.log
    [Transaction] Started: CompleteReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Aborted: CompleteReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

  console.error
    [Transaction] Failed: CompleteReservation {
      error: 'barberiaId es requerido para el aislamiento de datos',
      attempt: 1,
      stack: 'Error: barberiaId es requerido para el aislamiento de datos\n' +
        '    at MongoReservaRepository.findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:23:19)\n' +
        '    at findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:27:62)\n' +
        '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
        '    at Object.<anonymous>.exports.completarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:86:25)'
    }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m [35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CompleteReserva.execute (src/application/use-cases/reservas/CompleteReserva.js:24:24)
      at Object.<anonymous>.exports.completarReserva (src/controllers/reservas.controller.js:86:25)

  console.error
    ­ƒö┤ ERROR: TransactionError: Transaction failed for CompleteReservation: barberiaId es requerido para el aislamiento de datos
        at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:23)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at CompleteReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CompleteReserva.js:24:24)
        at Object.<anonymous>.exports.completarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:86:25) {
      isTransactionError: true,
      originalError: Error: barberiaId es requerido para el aislamiento de datos
          at MongoReservaRepository.findById (C:\Users\Kristian\Desktop\barber-saas\backend\src\infrastructure\database\mongodb\repositories\MongoReservaRepository.js:23:19)
          at findById (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CompleteReserva.js:27:62)
          at Function.operation [as executeInTransaction] (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:38)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at CompleteReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CompleteReserva.js:24:24)
          at Object.<anonymous>.exports.completarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:86:25),
      context: { operationName: 'CompleteReservation', attempt: 1 },
      timestamp: 2026-02-10T01:39:51.766Z,
      originalStack: 'Error: barberiaId es requerido para el aislamiento de datos\n' +
        '    at MongoReservaRepository.findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:23:19)\n' +
        '    at findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:27:62)\n' +
        '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
        '    at Object.<anonymous>.exports.completarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:86:25)'
    }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"­ƒö┤ ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/reservas.controller.js:95:9)

[0mPATCH /api/reservas/698a8c677ad9824b3cc32cdf/completar [31m500[0m 35.706 ms - 798[0m
  console.log
    ­ƒôí [PATCH] /api/reservas/698a8c677ad9824b3cc32d0c/cancelar

      at log (src/app.js:98:11)

  console.log
    [Transaction] Started: CancelReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Aborted: CancelReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

  console.error
    [Transaction] Failed: CancelReservation {
      error: 'barberiaId es requerido para el aislamiento de datos',
      attempt: 1,
      stack: 'Error: barberiaId es requerido para el aislamiento de datos\n' +
        '    at MongoReservaRepository.findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:23:19)\n' +
        '    at findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:25:62)\n' +
        '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at CancelReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:22:25)\n' +
        '    at Object.<anonymous>.exports.cancelarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:45:25)'
    }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m [35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CancelReserva.execute (src/application/use-cases/reservas/CancelReserva.js:22:25)
      at Object.<anonymous>.exports.cancelarReserva (src/controllers/reservas.controller.js:45:25)

  console.error
    ­ƒö┤ ERROR: TransactionError: Transaction failed for CancelReservation: barberiaId es requerido para el aislamiento de datos
        at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:23)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at CancelReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CancelReserva.js:22:25)
        at Object.<anonymous>.exports.cancelarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:45:25) {
      isTransactionError: true,
      originalError: Error: barberiaId es requerido para el aislamiento de datos
          at MongoReservaRepository.findById (C:\Users\Kristian\Desktop\barber-saas\backend\src\infrastructure\database\mongodb\repositories\MongoReservaRepository.js:23:19)
          at findById (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CancelReserva.js:25:62)
          at Function.operation [as executeInTransaction] (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:38)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at CancelReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CancelReserva.js:22:25)
          at Object.<anonymous>.exports.cancelarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:45:25),
      context: { operationName: 'CancelReservation', attempt: 1 },
      timestamp: 2026-02-10T01:39:51.968Z,
      originalStack: 'Error: barberiaId es requerido para el aislamiento de datos\n' +
        '    at MongoReservaRepository.findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.js:23:19)\n' +
        '    at findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:25:62)\n' +
        '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at CancelReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:22:25)\n' +
        '    at Object.<anonymous>.exports.cancelarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:45:25)'
    }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"­ƒö┤ ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/reservas.controller.js:56:9)

[0mPATCH /api/reservas/698a8c677ad9824b3cc32d0c/cancelar [31m500[0m 11.091 ms - 789[0m
  console.log
    ­ƒôí [GET] /api/reservas

      at log (src/app.js:98:11)

[0mGET /api/reservas [32m200[0m 20.541 ms - 243[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a8c687ad9824b3cc32d59","timestamp":"2026-02-10T01:39:52.352Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a8c687ad9824b3cc32d57","userId":"698a8c687ad9824b3cc32d5b"}
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 12.403 ms - 74[0m
  console.log
    ­ƒôí [POST] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"POST","requestedBarberiaId":"698a8c687ad9824b3cc32d87","timestamp":"2026-02-10T01:39:52.555Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a8c687ad9824b3cc32d85","userId":"698a8c687ad9824b3cc32d89"}
[0mPOST /api/barberias/test-barberia-b/admin/servicios [33m403[0m 7.602 ms - 74[0m
  console.log
    ­ƒôí [PUT] /api/barberias/test-barberia-b/admin/servicios/698a8c687ad9824b3cc32dc1

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"PUT","requestedBarberiaId":"698a8c687ad9824b3cc32db5","timestamp":"2026-02-10T01:39:52.740Z","url":"/api/barberias/test-barberia-b/admin/servicios/698a8c687ad9824b3cc32dc1","userBarberiaId":"698a8c687ad9824b3cc32db3","userId":"698a8c687ad9824b3cc32db7"}
[0mPUT /api/barberias/test-barberia-b/admin/servicios/698a8c687ad9824b3cc32dc1 [33m403[0m 6.429 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/barbero

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a8c687ad9824b3cc32de3","timestamp":"2026-02-10T01:39:52.921Z","url":"/api/barberias/test-barberia-b/barbero","userBarberiaId":"698a8c687ad9824b3cc32de1","userId":"698a8c687ad9824b3cc32de5"}
[0mGET /api/barberias/test-barberia-b/barbero [33m403[0m 6.740 ms - 74[0m
  console.log
    ­ƒôí [POST] /api/barberias/test-barberia-b/barbero

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"POST","requestedBarberiaId":"698a8c687ad9824b3cc32e11","timestamp":"2026-02-10T01:39:53.103Z","url":"/api/barberias/test-barberia-b/barbero","userBarberiaId":"698a8c687ad9824b3cc32e0f","userId":"698a8c687ad9824b3cc32e13"}
[0mPOST /api/barberias/test-barberia-b/barbero [33m403[0m 7.687 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a8c697ad9824b3cc32e3f","timestamp":"2026-02-10T01:39:53.287Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a8c697ad9824b3cc32e3d","userId":"698a8c697ad9824b3cc32e41"}
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 7.387 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/slug-inexistente/admin/servicios

      at log (src/app.js:98:11)

[0mGET /api/barberias/slug-inexistente/admin/servicios [33m404[0m 7.943 ms - 37[0m
  console.log
    ­ƒôí [GET] /api/reservas?barberiaId=698a8c697ad9824b3cc32e9b

      at log (src/app.js:98:11)

[0mGET /api/reservas?barberiaId=698a8c697ad9824b3cc32e9b [32m200[0m 13.222 ms - 243[0m
  console.log
    ­ƒôí [POST] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

[0mPOST /api/barberias/test-barberia-a/admin/servicios [33m400[0m 13.375 ms - 58[0m
  console.log
    ­ƒôí [GET] /api/reservas/698a8c6a7ad9824b3cc32f09

      at log (src/app.js:98:11)

[0mGET /api/reservas/698a8c6a7ad9824b3cc32f09 [33m403[0m 11.413 ms - 45[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

[0mGET /api/barberias/test-barberia-a/admin/servicios [32m200[0m 17.537 ms - 257[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[0mGET /api/barberias/test-barberia-b/admin/servicios [32m200[0m 13.208 ms - 257[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a8c6a7ad9824b3cc32f8d","timestamp":"2026-02-10T01:39:54.626Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a8c6a7ad9824b3cc32f8b","userId":"698a8c6a7ad9824b3cc32f8f"}
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 6.563 ms - 74[0m
  console.warn
    ÔÜá´©Å MongoDB desconectado

    [0m [90m 89 |[39m   mongoose[33m.[39mconnection[33m.[39mon([32m'disconnected'[39m[33m,[39m () [33m=>[39m {
     [90m 90 |[39m     isConnected [33m=[39m [36mfalse[39m[33m;[39m
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39mwarn([32m'ÔÜá´©Å MongoDB desconectado'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m   })[33m;[39m
     [90m 93 |[39m
     [90m 94 |[39m   mongoose[33m.[39mconnection[33m.[39mon([32m'error'[39m[33m,[39m (err) [33m=>[39m {[0m

      at NativeConnection.warn (src/config/db.js:91:13)
      at NativeConnection.set (node_modules/mongoose/lib/connection.js:149:12)
      at NativeConnection.onClose (node_modules/mongoose/lib/connection.js:1319:19)
      at NativeConnection._close (node_modules/mongoose/lib/connection.js:1268:12)
      at closeDB (tests/setup.js:29:5)
      at Object.<anonymous> (tests/multi-tenant-security.test.js:24:9)

FAIL tests/multi-tenan
t-security.test.js 
(6.667 s)
  ƒöÉ Multi-Tenant 
Security Tests
    ƒÜ½ Reservas - 
Cross-Tenant Access 
Prevention
      ├ù Admin A NO 
puede ver reserva de 
Barber├¡a B (142 ms)
      ├ù Admin A NO 
puede editar reserva 
de Barber├¡a B (385 
ms)
      ├ù Admin A NO 
puede cancelar 
reserva de Barber├¡a 
B (190 ms)
      ├ù Admin A solo 
ve sus propias 
reservas al listar 
(197 ms)
    ƒÜ½ Servicios - 
Cross-Tenant Access 
Prevention
      ÔêÜ Admin A NO 
puede acceder a 
servicios de 
Barber├¡a B v├¡a slug 
(187 ms)
      ÔêÜ Admin A NO 
puede crear servicio 
en Barber├¡a B (201 
ms)
      ÔêÜ Admin A NO 
puede editar servicio 
de Barber├¡a B (185 
ms)
    ƒÜ½ Barberos - 
Cross-Tenant Access 
Prevention
      ÔêÜ Admin A NO 
puede ver barberos de 
Barber├¡a B (182 ms)
      ÔêÜ Admin A NO 
puede crear barbero 
en Barber├¡a B (181 
ms)
    ƒöÆ URL Slug 
Manipulation Attempts
      ÔêÜ Rechaza 
intento de acceder 
con slug incorrecto 
(184 ms)
      ÔêÜ Rechaza 
slug inexistente (186 
ms)
    ƒöÆ Query 
Parameter Injection 
Prevention
      ├ù Ignora 
barberiaId inyectado 
en query params (217 
ms)
      ├ù Ignora 
barberiaId inyectado 
en request body (187 
ms)
    Ô£à Legitimate 
Access Allowed
      ├ù Admin A 
puede ver sus propias 
reservas (186 ms)
      ├ù Admin A 
puede acceder a sus 
servicios (193 ms)
      ÔêÜ Admin B 
puede acceder a sus 
propios datos (186 ms)
    ƒöì Logging and 
Monitoring
      ÔêÜ Loguea 
intentos de acceso 
cross-tenant (182 ms)
    ƒææ SUPERADMIN 
Access
      ├ù SUPERADMIN 
puede acceder a 
cualquier barber├¡a 
(165 ms)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒÜ½ 
Reservas - 
Cross-Tenant Access 
Prevention ÔÇ║ Admin 
A NO puede ver 
reserva de Barber├¡a B

    MongoServerError: 
BSON field 
'delete.deletes.q' is 
missing but a 
required field

      at Connection.se
ndCommand (node_module
s/mongodb/src/cmap/con
nection.ts:557:17)
      at 
Connection.command (no
de_modules/mongodb/src
/cmap/connection.ts:62
7:22)
      at 
Server.command (node_m
odules/mongodb/src/sda
m/server.ts:350:21)
      at tryOperation 
(node_modules/mongodb/
src/operations/execute
_operation.ts:293:24)
      at 
executeOperation (node
_modules/mongodb/src/o
perations/execute_oper
ation.ts:123:12)
      at 
Collection.deleteMany 
(node_modules/mongodb/
src/collection.ts:482:
12)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒÜ½ 
Reservas - 
Cross-Tenant Access 
Prevention ÔÇ║ Admin 
A NO puede editar 
reserva de Barber├¡a B

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 148 
|[39m                
 [33m.[39m[36mset[
39m([32m'Authorizatio
n'[39m[33m,[39m 
[32m`Bearer ${tokenAd
minA}`[39m)[33m;[39
m
     [90m 149 |[39m
    [31m[1m>[22m[3
9m[90m 150 |[39m    
         expect(res[3
3m.[39mstatus)[33m.
[39mtoBe([35m404[39m
)[33m;[39m
     [90m     |[39m 
                      
         
[31m[1m^[22m[39m
     [90m 151 |[39m 
        })[33m;[39m
     [90m 152 |[39m
     [90m 153 |[39m 
        
it([32m'Admin A NO 
puede cancelar 
reserva de Barber├¡a 
B'[39m[33m,[39m 
[36masync[39m () 
[33m=>[39m {[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:150:32)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒÜ½ 
Reservas - 
Cross-Tenant Access 
Prevention ÔÇ║ Admin 
A NO puede cancelar 
reserva de Barber├¡a B

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 156 
|[39m                
 [33m.[39m[36mset[
39m([32m'Authorizatio
n'[39m[33m,[39m 
[32m`Bearer ${tokenAd
minA}`[39m)[33m;[39
m
     [90m 157 |[39m
    [31m[1m>[22m[3
9m[90m 158 |[39m    
         expect(res[3
3m.[39mstatus)[33m.
[39mtoBe([35m404[39m
)[33m;[39m
     [90m     |[39m 
                      
         
[31m[1m^[22m[39m
     [90m 159 |[39m 
        })[33m;[39m
     [90m 160 |[39m
     [90m 161 |[39m 
        
it([32m'Admin A solo 
ve sus propias 
reservas al listar'[3
9m[33m,[39m 
[36masync[39m () 
[33m=>[39m {[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:158:32)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒÜ½ 
Reservas - 
Cross-Tenant Access 
Prevention ÔÇ║ Admin 
A solo ve sus propias 
reservas al listar

    TypeError: 
res.body.map is not a 
function

    [0m [90m 165 
|[39m
     [90m 166 |[39m 
            expect(res
[33m.[39mstatus)[33
m.[39mtoBe([35m200[
39m)[33m;[39m
    [31m[1m>[22m[3
9m[90m 167 |[39m    
         
[36mconst[39m ids 
[33m=[39m res[33m.
[39mbody[33m.[39mmap
(r [33m=>[39m r[33m
.[39m_id[33m.[39mto
String())[33m;[39m
     [90m     |[39m 
                      
           
[31m[1m^[22m[39m
     [90m 168 |[39m 
            expect(ids
)[33m.[39mtoContain(
reservaA[33m.[39m_id
[33m.[39mtoString())
[33m;[39m
     [90m 169 |[39m 
            expect(ids
)[33m.[39mnot[33m.
[39mtoContain(reservaB
[33m.[39m_id[33m.[
39mtoString())[33m;[
39m
     [90m 170 |[39m 
        
})[33m;[39m[0m

      at Object.map (t
ests/multi-tenant-secu
rity.test.js:167:34)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒöÆ Query 
Parameter Injection 
Prevention ÔÇ║ Ignora 
barberiaId inyectado 
en query params

    TypeError: 
res.body.map is not a 
function

    [0m [90m 257 
|[39m             exp
ect(res[33m.[39mstat
us)[33m.[39mtoBe([3
5m200[39m)[33m;[39m
     [90m 258 |[39m 
            [90m// 
Debe usar 
req.user.barberiaId, 
no el query param[39m
    [31m[1m>[22m[3
9m[90m 259 |[39m    
         
[36mconst[39m ids 
[33m=[39m res[33m.
[39mbody[33m.[39mmap
(r [33m=>[39m r[33m
.[39m_id[33m.[39mto
String())[33m;[39m
     [90m     |[39m 
                      
           
[31m[1m^[22m[39m
     [90m 260 |[39m 
            expect(ids
)[33m.[39mnot[33m.
[39mtoContain(reservaB
[33m.[39m_id[33m.[
39mtoString())[33m;[
39m
     [90m 261 |[39m 
        })[33m;[39m
     [90m 262 
|[39m[0m

      at Object.map (t
ests/multi-tenant-secu
rity.test.js:259:34)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒöÆ Query 
Parameter Injection 
Prevention ÔÇ║ Ignora 
barberiaId inyectado 
en request body

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: 201
    Received: 400

    [0m [90m 272 
|[39m                
 })[33m;[39m
     [90m 273 |[39m
    [31m[1m>[22m[3
9m[90m 274 |[39m    
         expect(res[3
3m.[39mstatus)[33m.
[39mtoBe([35m201[39m
)[33m;[39m
     [90m     |[39m 
                      
         
[31m[1m^[22m[39m
     [90m 275 |[39m
     [90m 276 |[39m 
            [90m// 
Verificar que se 
cre├│ con barberiaId 
correcto[39m
     [90m 277 |[39m 
            
[36mconst[39m 
servicio [33m=[39m 
[36mawait[39m [33mS
ervicio[39m[33m.[39
mfindById(res[33m.[3
9mbody[33m.[39mservi
cio[33m.[39m_id)[33
m;[39m[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:274:32)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ Ô£à 
Legitimate Access 
Allowed ÔÇ║ Admin A 
puede ver sus propias 
reservas

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: 200
    Received: 403

    [0m [90m 287 
|[39m                
 [33m.[39m[36mset[
39m([32m'Authorizatio
n'[39m[33m,[39m 
[32m`Bearer ${tokenAd
minA}`[39m)[33m;[39
m
     [90m 288 |[39m
    [31m[1m>[22m[3
9m[90m 289 |[39m    
         expect(res[3
3m.[39mstatus)[33m.
[39mtoBe([35m200[39m
)[33m;[39m
     [90m     |[39m 
                      
         
[31m[1m^[22m[39m
     [90m 290 |[39m 
            expect(res
[33m.[39mbody[33m.
[39m_id)[33m.[39mtoB
e(reservaA[33m.[39m_
id[33m.[39mtoString(
))[33m;[39m
     [90m 291 |[39m 
        })[33m;[39m
     [90m 292 
|[39m[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:289:32)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ Ô£à 
Legitimate Access 
Allowed ÔÇ║ Admin A 
puede acceder a sus 
servicios

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: true
    Received: false

    [0m [90m 297 
|[39m
     [90m 298 |[39m 
            expect(res
[33m.[39mstatus)[33
m.[39mtoBe([35m200[
39m)[33m;[39m
    [31m[1m>[22m[3
9m[90m 299 |[39m    
         expect([33mA
rray[39m[33m.[39mis
Array(res[33m.[39mbo
dy))[33m.[39mtoBe([
36mtrue[39m)[33m;[3
9m
     [90m     |[39m 
                      
                      
[31m[1m^[22m[39m
     [90m 300 |[39m 
        })[33m;[39m
     [90m 301 |[39m
     [90m 302 |[39m 
        
it([32m'Admin B 
puede acceder a sus 
propios datos'[39m[3
3m,[39m 
[36masync[39m () 
[33m=>[39m {[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:299:45)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒææ 
SUPERADMIN Access ÔÇ║ 
SUPERADMIN puede 
acceder a cualquier 
barber├¡a

    ValidationError: 
User validation 
failed: rol: 
`SUPERADMIN` is not a 
valid enum value for 
path `rol`.

    [0m [90m 326 
|[39m
     [90m 327 |[39m 
        beforeEach([3
6masync[39m () 
[33m=>[39m {
    [31m[1m>[22m[3
9m[90m 328 |[39m    
         superAdmin 
[33m=[39m 
[36mawait[39m [33mU
ser[39m[33m.[39mcre
ate({
     [90m     |[39m 
                      
   
[31m[1m^[22m[39m
     [90m 329 |[39m 
                
nombre[33m:[39m 
[32m'Super 
Admin'[39m[33m,[39m
     [90m 330 |[39m 
                
email[33m:[39m [32m
'superadmin@barber.com
'[39m[33m,[39m
     [90m 331 |[39m 
                
password[33m:[39m [
32m'password123'[39m
[33m,[39m[0m

      at model.Object.
<anonymous>.Document.i
nvalidate (node_module
s/mongoose/lib/documen
t.js:3370:32)
      at validatePath 
(node_modules/mongoose
/lib/document.js:3145:
13)
          at async 
Promise.all (index 3)
      at 
model.$__validate (nod
e_modules/mongoose/lib
/document.js:3086:3)
      at 
model.validate (node_m
odules/mongoose/lib/do
cument.js:2663:5)
      at model.validat
eBeforeSave (node_modu
les/mongoose/lib/plugi
ns/validateBeforeSave.
js:34:7)
      at 
Kareem.execPre (node_m
odules/kareem/index.js
:65:24)
      at 
model.$__save (node_mo
dules/mongoose/lib/mod
el.js:369:5)
      at model.save (n
ode_modules/mongoose/l
ib/model.js:609:5)
      at node_modules/
mongoose/lib/model.js:
2722:9
          at async 
Promise.all (index 0)
      at 
Function.create (node_
modules/mongoose/lib/m
odel.js:2707:11)
      at 
Object.<anonymous> (te
sts/multi-tenant-secur
ity.test.js:328:26)

Test Suites: 1 
failed, 1 total
Tests:       9 
failed, 9 passed, 18 
total
Snapshots:   0 total
Time:        6.733 s, 
estimated 8 s
Ran all test suites 
matching /tests\\multi
-tenant-security.test.
js/i.
