
> backend@1.0.0 test
> jest --runInBand --detectOpenHandles tests/multi-tenant-security.test.js

  console.log
    [dotenv@17.2.3] injecting env (13) from .env -- tip: ÔÜÖ´©Å  write to custom object with { processEnv: myObject }

      at _log (node_modules/dotenv/lib/main.js:142:11)

node.exe : 
(node:20208) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
En línea: 1 Carácter: 
1
+ & "C:\Program Files\
nodejs/node.exe" 
"C:\Program 
Files\nodejs/node_mo 
...
+ ~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~
~~~~~
    + CategoryInfo    
      : NotSpecified: 
((node:20208) 
[M...dex 
definition.:String) 
[]    , 
RemoteException
    + 
FullyQualifiedErrorId 
: NativeCommandError
 
(Use `node 
--trace-warnings ...` 
to show where the 
warning was created)
(node:20208) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"numeroPedido":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:20208) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"expiraEn":1} found. 
This is often due to 
declaring an index 
using both "index: 
true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:20208) 
[MONGOOSE] Warning: 
Duplicate schema 
index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
  console.log
    ­ƒôí [GET] /api/reservas/698a92292c7a7d2171664648

      at log (src/app.js:98:11)

[0mGET /api/reservas/698a92292c7a7d2171664648 [33m404[0m 20.859 ms - 35[0m
  console.log
    ­ƒôí [PATCH] /api/reservas/698a92292c7a7d2171664676/completar

      at log (src/app.js:98:11)

  console.log
    [Transaction] Started: CompleteReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Aborted: CompleteReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

  console.error
    [Transaction] Failed: CompleteReservation {
      error: 'Reserva no encontrada',
      attempt: 1,
      stack: 'Error: Reserva no encontrada\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:30:35)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
        '    at Object.<anonymous>.exports.completarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:87:25)'
    }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m [35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CompleteReserva.execute (src/application/use-cases/reservas/CompleteReserva.js:24:24)
      at Object.<anonymous>.exports.completarReserva (src/controllers/reservas.controller.js:87:25)

  console.error
    ­ƒö┤ ERROR: TransactionError: Transaction failed for CompleteReservation: Reserva no encontrada
        at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at CompleteReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CompleteReserva.js:24:24)
        at Object.<anonymous>.exports.completarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:87:25) {
      isTransactionError: true,
      originalError: Error: Reserva no encontrada
          at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CompleteReserva.js:30:35)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
          at CompleteReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CompleteReserva.js:24:24)
          at Object.<anonymous>.exports.completarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:87:25) {
        statusCode: 404
      },
      context: { operationName: 'CompleteReservation', attempt: 1 },
      timestamp: 2026-02-10T02:04:25.344Z,
      originalStack: 'Error: Reserva no encontrada\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:30:35)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
        '    at Object.<anonymous>.exports.completarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:87:25)',
      statusCode: 404
    }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"­ƒö┤ ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/reservas.controller.js:97:9)

[0mPATCH /api/reservas/698a92292c7a7d2171664676/completar [33m404[0m 20.034 ms - 736[0m
  console.log
    ­ƒôí [PATCH] /api/reservas/698a92292c7a7d21716646a4/cancelar

      at log (src/app.js:98:11)

  console.log
    [Transaction] Started: CancelReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

  console.log
    [Transaction] Aborted: CancelReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

  console.error
    [Transaction] Failed: CancelReservation {
      error: 'Reserva no encontrada',
      attempt: 1,
      stack: 'Error: Reserva no encontrada\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:28:35)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CancelReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:22:25)\n' +
        '    at Object.<anonymous>.exports.cancelarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:45:25)'
    }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m [35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CancelReserva.execute (src/application/use-cases/reservas/CancelReserva.js:22:25)
      at Object.<anonymous>.exports.cancelarReserva (src/controllers/reservas.controller.js:45:25)

  console.error
    ­ƒö┤ ERROR: TransactionError: Transaction failed for CancelReservation: Reserva no encontrada
        at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at CancelReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CancelReserva.js:22:25)
        at Object.<anonymous>.exports.cancelarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:45:25) {
      isTransactionError: true,
      originalError: Error: Reserva no encontrada
          at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CancelReserva.js:28:35)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at Function.executeInTransaction (C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
          at CancelReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\application\use-cases\reservas\CancelReserva.js:22:25)
          at Object.<anonymous>.exports.cancelarReserva (C:\Users\Kristian\Desktop\barber-saas\backend\src\controllers\reservas.controller.js:45:25) {
        statusCode: 404
      },
      context: { operationName: 'CancelReservation', attempt: 1 },
      timestamp: 2026-02-10T02:04:25.543Z,
      originalStack: 'Error: Reserva no encontrada\n' +
        '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:28:35)\n' +
        '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
        '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
        '    at CancelReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js:22:25)\n' +
        '    at Object.<anonymous>.exports.cancelarReserva (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:45:25)',
      statusCode: 404
    }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"­ƒö┤ ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/reservas.controller.js:57:9)

[0mPATCH /api/reservas/698a92292c7a7d21716646a4/cancelar [33m404[0m 12.286 ms - 727[0m
  console.log
    ­ƒôí [GET] /api/reservas

      at log (src/app.js:98:11)

[0mGET /api/reservas [32m200[0m 19.679 ms - 243[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a92292c7a7d21716646f2","timestamp":"2026-02-10T02:04:25.927Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a92292c7a7d21716646f0","userId":"698a92292c7a7d21716646f4"}
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 12.219 ms - 74[0m
  console.log
    ­ƒôí [POST] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"POST","requestedBarberiaId":"698a92292c7a7d2171664720","timestamp":"2026-02-10T02:04:26.123Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a92292c7a7d217166471e","userId":"698a92292c7a7d2171664722"}
[0mPOST /api/barberias/test-barberia-b/admin/servicios [33m403[0m 7.166 ms - 74[0m
  console.log
    ­ƒôí [PUT] /api/barberias/test-barberia-b/admin/servicios/698a922a2c7a7d217166475a

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"PUT","requestedBarberiaId":"698a922a2c7a7d217166474e","timestamp":"2026-02-10T02:04:26.306Z","url":"/api/barberias/test-barberia-b/admin/servicios/698a922a2c7a7d217166475a","userBarberiaId":"698a922a2c7a7d217166474c","userId":"698a922a2c7a7d2171664750"}
[0mPUT /api/barberias/test-barberia-b/admin/servicios/698a922a2c7a7d217166475a [33m403[0m 6.590 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/barbero

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a922a2c7a7d217166477c","timestamp":"2026-02-10T02:04:26.491Z","url":"/api/barberias/test-barberia-b/barbero","userBarberiaId":"698a922a2c7a7d217166477a","userId":"698a922a2c7a7d217166477e"}
[0mGET /api/barberias/test-barberia-b/barbero [33m403[0m 6.514 ms - 74[0m
  console.log
    ­ƒôí [POST] /api/barberias/test-barberia-b/barbero

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"POST","requestedBarberiaId":"698a922a2c7a7d21716647aa","timestamp":"2026-02-10T02:04:26.678Z","url":"/api/barberias/test-barberia-b/barbero","userBarberiaId":"698a922a2c7a7d21716647a8","userId":"698a922a2c7a7d21716647ac"}
[0mPOST /api/barberias/test-barberia-b/barbero [33m403[0m 6.802 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a922a2c7a7d21716647d8","timestamp":"2026-02-10T02:04:26.861Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a922a2c7a7d21716647d6","userId":"698a922a2c7a7d21716647da"}
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 6.999 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/slug-inexistente/admin/servicios

      at log (src/app.js:98:11)

[0mGET /api/barberias/slug-inexistente/admin/servicios [33m404[0m 5.989 ms - 37[0m
  console.log
    ­ƒôí [GET] /api/reservas?barberiaId=698a922b2c7a7d2171664834

      at log (src/app.js:98:11)

[0mGET /api/reservas?barberiaId=698a922b2c7a7d2171664834 [32m200[0m 14.371 ms - 243[0m
  console.log
    ­ƒôí [POST] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

[0mPOST /api/barberias/test-barberia-a/admin/servicios [33m400[0m 12.434 ms - 58[0m
  console.log
    ­ƒôí [GET] /api/reservas/698a922b2c7a7d21716648a2

      at log (src/app.js:98:11)

[0mGET /api/reservas/698a922b2c7a7d21716648a2 [32m200[0m 12.782 ms - 218[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

[0mGET /api/barberias/test-barberia-a/admin/servicios [32m200[0m 15.458 ms - 257[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[0mGET /api/barberias/test-barberia-b/admin/servicios [32m200[0m 13.944 ms - 257[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a922c2c7a7d2171664926","timestamp":"2026-02-10T02:04:28.194Z","url":"/api/barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a922c2c7a7d2171664924","userId":"698a922c2c7a7d2171664928"}
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 6.438 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a922c2c7a7d2171664952","timestamp":"2026-02-10T02:04:28.433Z","url":"/api/barberias/test-barberia-a/admin/servicios","userId":"698a922c2c7a7d2171664966"}
[0mGET /api/barberias/test-barberia-a/admin/servicios [33m403[0m 6.266 ms - 74[0m
  console.log
    ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

[33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedBarberiaId":"698a922c2c7a7d2171664954","timestamp":"2026-02-10T02:04:28.446Z","url":"/api/barberias/test-barberia-b/admin/servicios","userId":"698a922c2c7a7d2171664966"}
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 6.199 ms - 74[0m
  console.warn
    ÔÜá´©Å MongoDB desconectado

    [0m [90m 89 |[39m   mongoose[33m.[39mconnection[33m.[39mon([32m'disconnected'[39m[33m,[39m () [33m=>[39m {
     [90m 90 |[39m     isConnected [33m=[39m [36mfalse[39m[33m;[39m
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39mwarn([32m'ÔÜá´©Å MongoDB desconectado'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m   })[33m;[39m
     [90m 93 |[39m
     [90m 94 |[39m   mongoose[33m.[39mconnection[33m.[39mon([32m'error'[39m[33m,[39m (err) [33m=>[39m {[0m

      at NativeConnection.warn (src/config/db.js:91:13)
      at NativeConnection.set (node_modules/mongoose/lib/connection.js:149:12)
      at NativeConnection.onClose (node_modules/mongoose/lib/connection.js:1319:19)
      at NativeConnection._close (node_modules/mongoose/lib/connection.js:1268:12)
      at closeDB (tests/setup.js:29:5)
      at Object.<anonymous> (tests/multi-tenant-security.test.js:24:9)

FAIL tests/multi-tenan
t-security.test.js 
(6.108 s)
  ƒöÉ Multi-Tenant 
Security Tests
    ƒÜ½ Reservas - 
Cross-Tenant Access 
Prevention
      ÔêÜ Admin A NO 
puede ver reserva de 
Barber├¡a B (480 ms)
      ÔêÜ Admin A NO 
puede editar reserva 
de Barber├¡a B (204 
ms)
      ÔêÜ Admin A NO 
puede cancelar 
reserva de Barber├¡a 
B (196 ms)
      ÔêÜ Admin A 
solo ve sus propias 
reservas al listar 
(194 ms)
    ƒÜ½ Servicios - 
Cross-Tenant Access 
Prevention
      ÔêÜ Admin A NO 
puede acceder a 
servicios de 
Barber├¡a B v├¡a slug 
(191 ms)
      ÔêÜ Admin A NO 
puede crear servicio 
en Barber├¡a B (194 
ms)
      ÔêÜ Admin A NO 
puede editar servicio 
de Barber├¡a B (182 
ms)
    ƒÜ½ Barberos - 
Cross-Tenant Access 
Prevention
      ÔêÜ Admin A NO 
puede ver barberos de 
Barber├¡a B (185 ms)
      ÔêÜ Admin A NO 
puede crear barbero 
en Barber├¡a B (187 
ms)
    ƒöÆ URL Slug 
Manipulation Attempts
      ÔêÜ Rechaza 
intento de acceder 
con slug incorrecto 
(184 ms)
      ÔêÜ Rechaza 
slug inexistente (199 
ms)
    ƒöÆ Query 
Parameter Injection 
Prevention
      ÔêÜ Ignora 
barberiaId inyectado 
en query params (194 
ms)
      ├ù Ignora 
barberiaId inyectado 
en request body (191 
ms)
    Ô£à Legitimate 
Access Allowed
      ÔêÜ Admin A 
puede ver sus propias 
reservas (187 ms)
      ├ù Admin A 
puede acceder a sus 
servicios (190 ms)
      ÔêÜ Admin B 
puede acceder a sus 
propios datos (190 ms)
    ƒöì Logging and 
Monitoring
      ÔêÜ Loguea 
intentos de acceso 
cross-tenant (179 ms)
    ƒææ SUPERADMIN 
Access
      ├ù SUPERADMIN 
puede acceder a 
cualquier barber├¡a 
(252 ms)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒöÆ Query 
Parameter Injection 
Prevention ÔÇ║ Ignora 
barberiaId inyectado 
en request body

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: 201
    Received: 400

    [0m [90m 277 
|[39m                
 })[33m;[39m
     [90m 278 |[39m
    [31m[1m>[22m[3
9m[90m 279 |[39m    
         expect(res[3
3m.[39mstatus)[33m.
[39mtoBe([35m201[39m
)[33m;[39m
     [90m     |[39m 
                      
         
[31m[1m^[22m[39m
     [90m 280 |[39m
     [90m 281 |[39m 
            [90m// 
Verificar que se 
cre├│ con barberiaId 
correcto[39m
     [90m 282 |[39m 
            
[36mconst[39m 
servicio [33m=[39m 
[36mawait[39m [33mS
ervicio[39m[33m.[39
mfindById(res[33m.[3
9mbody[33m.[39mservi
cio[33m.[39m_id)[33
m;[39m[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:279:32)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ Ô£à 
Legitimate Access 
Allowed ÔÇ║ Admin A 
puede acceder a sus 
servicios

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: true
    Received: false

    [0m [90m 302 
|[39m
     [90m 303 |[39m 
            expect(res
[33m.[39mstatus)[33
m.[39mtoBe([35m200[
39m)[33m;[39m
    [31m[1m>[22m[3
9m[90m 304 |[39m    
         expect([33mA
rray[39m[33m.[39mis
Array(res[33m.[39mbo
dy))[33m.[39mtoBe([
36mtrue[39m)[33m;[3
9m
     [90m     |[39m 
                      
                      
[31m[1m^[22m[39m
     [90m 305 |[39m 
        })[33m;[39m
     [90m 306 |[39m
     [90m 307 |[39m 
        
it([32m'Admin B 
puede acceder a sus 
propios datos'[39m[3
3m,[39m 
[36masync[39m () 
[33m=>[39m {[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:304:45)

  ÔùÅ ƒöÉ 
Multi-Tenant Security 
Tests ÔÇ║ ƒææ 
SUPERADMIN Access ÔÇ║ 
SUPERADMIN puede 
acceder a cualquier 
barber├¡a

    expect(received).t
oBe(expected) // 
Object.is equality

    Expected: 200
    Received: 403

    [0m [90m 351 
|[39m                
 [33m.[39m[36mset[
39m([32m'Authorizatio
n'[39m[33m,[39m 
[32m`Bearer ${tokenSu
perAdmin}`[39m)[33m;
[39m
     [90m 352 |[39m
    [31m[1m>[22m[3
9m[90m 353 |[39m    
         expect(resA[
33m.[39mstatus)[33m.
[39mtoBe([35m200[39
m)[33m;[39m
     [90m     |[39m 
                      
          
[31m[1m^[22m[39m
     [90m 354 |[39m 
            expect(res
B[33m.[39mstatus)[3
3m.[39mtoBe([35m200
[39m)[33m;[39m
     [90m 355 |[39m 
        })[33m;[39m
     [90m 356 |[39m 
    })[33m;[39m[0m

      at Object.toBe (
tests/multi-tenant-sec
urity.test.js:353:33)

Test Suites: 1 
failed, 1 total
Tests:       3 
failed, 15 passed, 18 
total
Snapshots:   0 total
Time:        6.173 s, 
estimated 7 s
Ran all test suites 
matching /tests\\multi
-tenant-security.test.
js/i.
