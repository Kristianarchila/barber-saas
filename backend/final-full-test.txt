
> backend@1.0.0 test
> jest --runInBand --detectOpenHandles

node.exe : (node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} 
found. This is often due to declaring an index using both "index: true" and 
"schema.index()". Please remove the duplicate index definition.
En línea: 1 Carácter: 1
+ & "C:\Program Files\nodejs/node.exe" "C:\Program Files\nodejs/node_mo ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: ((node:26752) [M...dex definition.:String) [] 
   , RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
(Use `node --trace-warnings ...` to show where the warning was created)
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"numeroPedido":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"expiraEn":1} found. This is 
often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
[0mPOST /api/public/barberia-test/resenas?reviewToken=1327bfa01fc8df90fe93f221d8f34a27199ee9585589f84d72257946dac6bdf2 [32m201[0m 20.092 ms - 646[0m
[0mPOST /api/public/barberia-test/resenas [33m404[0m 5.531 ms - 51[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=invalid-token [33m404[0m 5.728 ms - 51[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=212cc1154ab4204ab1e073044a74b60340c6f8733ecc53cb1ff84255c6d747f4 [32m201[0m 10.700 ms - 611[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=212cc1154ab4204ab1e073044a74b60340c6f8733ecc53cb1ff84255c6d747f4 [31m500[0m 22.437 ms - 55[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=4c67900071af2650f571fd15c14dad4054ca5656851214ee218ab21e839f91d6 [31m500[0m 8.563 ms - 55[0m
[0mGET /api/public/barberia-test/resenas/validar-token?reviewToken=f0a5dc4f751824f1173912cfc7b397ecafb53e8a5db3b19f332ba3bbb92dfcb8 [32m200[0m 15.787 ms - 144[0m
[0mGET /api/public/barberia-test/resenas/validar-token?reviewToken=invalid [33m404[0m 4.729 ms - 45[0m
[0mGET /api/public/barberia-test/resenas [32m200[0m 13.959 ms - 849[0m
[0mGET /api/public/barberia-test/resenas [32m200[0m 13.073 ms - 849[0m
[0mGET /api/admin/resenas/pendientes [32m200[0m 11.425 ms - 424[0m
[0mGET /api/admin/resenas/pendientes [33m401[0m 0.361 ms - 27[0m
[0mPATCH /api/admin/resenas/698a93861ca2aac760c39faa/aprobar [32m200[0m 8.219 ms - 448[0m
[0mPATCH /api/admin/resenas/698a93871ca2aac760c39fbe/aprobar [33m401[0m 0.310 ms - 27[0m
[0mGET /api/admin/resenas/estadisticas [32m200[0m 6.069 ms - 91[0m
[0mGET /api/public/barberia-test/resenas [32m200[0m 10.154 ms - 464[0m
FAIL tests/resenas.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (13) from .env -- tip: ƒöä add secrets lifecycle 
management: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

    console.log
      ƒôí [POST] /api/public/barberia-test/resenas?reviewToken=1327bfa01fc8df90fe93f221d8f
34a27199ee9585589f84d72257946dac6bdf2

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/barberia-test/resenas

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/barberia-test/resenas?reviewToken=invalid-token

      at log (src/app.js:98:11)

    console.log
      ƒôí [POST] /api/public/barberia-test/resenas?reviewToken=212cc1154ab4204ab1e073044a7
4b60340c6f8733ecc53cb1ff84255c6d747f4

      at log (src/app.js:98:11)

    console.log
      ƒôí [POST] /api/public/barberia-test/resenas?reviewToken=212cc1154ab4204ab1e073044a7
4b60340c6f8733ecc53cb1ff84255c6d747f4

      at log (src/app.js:98:11)

    console.error
      Error al crear rese├▒a: MongoServerError: E11000 duplicate key error collection: 
barber-saas-test.resenas index: reservaId_1 dup key: { reservaId: 
ObjectId('698a93861ca2aac760c39ef6') }
          at InsertOneOperation.handleOk (C:\Users\Kristian\Desktop\barber-saas\backend\no
de_modules\mongodb\src\operations\insert.ts:79:13)
          at tryOperation (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mong
odb\src\operations\execute_operation.ts:294:26)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at executeOperation (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\
mongodb\src\operations\execute_operation.ts:123:12)
          at Collection.insertOne (C:\Users\Kristian\Desktop\barber-saas\backend\node_modu
les\mongodb\src\collection.ts:294:12)
          at model.$__save 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:398:16)
          at model.save 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:609:5)
          at Object.<anonymous>.exports.crearResena (C:\Users\Kristian\Desktop\barber-saas
\backend\src\controllers\resenas.controller.js:96:9) {
        errorLabelSet: Set(0) {},
        errorResponse: {
          index: 0,
          code: 11000,
          errmsg: "E11000 duplicate key error collection: barber-saas-test.resenas index: 
reservaId_1 dup key: { reservaId: ObjectId('698a93861ca2aac760c39ef6') }",
          keyPattern: { reservaId: 1 },
          keyValue: { reservaId: new ObjectId('698a93861ca2aac760c39ef6') }
        },
        index: 0,
        code: 11000,
        keyPattern: { reservaId: 1 },
        keyValue: { reservaId: new ObjectId('698a93861ca2aac760c39ef6') }
      }

    [0m [90m 106 |[39m         })[33m;[39m
     [90m 107 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 108 |[39m         console[33m.[39merror([32m"Error al 
crear rese├▒a:"[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 109 |[39m         res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ 
success[33m:[39m [36mfalse[39m[33m,[39m message[33m:[39m [32m"Error al crear la 
rese├▒a"[39m })[33m;[39m
     [90m 110 |[39m     }
     [90m 111 |[39m }[33m;[39m[0m

      at error (src/controllers/resenas.controller.js:108:17)

    console.log
      ƒôí [POST] /api/public/barberia-test/resenas?reviewToken=4c67900071af2650f571fd15c14
dad4054ca5656851214ee218ab21e839f91d6

      at log (src/app.js:98:11)

    console.error
      Error al crear rese├▒a: ValidationError: Resena validation failed: 
calificacionGeneral: Path `calificacionGeneral` is required.
          at model.Object.<anonymous>.Document.invalidate (C:\Users\Kristian\Desktop\barbe
r-saas\backend\node_modules\mongoose\lib\document.js:3370:32)
          at validatePath (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mong
oose\lib\document.js:3145:13)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at async Promise.all (index 5)
          at model.$__validate (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules
\mongoose\lib\document.js:3086:3)
          at model.validate (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mo
ngoose\lib\document.js:2663:5)
          at model.validateBeforeSave (C:\Users\Kristian\Desktop\barber-saas\backend\node_
modules\mongoose\lib\plugins\validateBeforeSave.js:34:7)
          at Kareem.execPre 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\kareem\index.js:65:24)
          at model.$__save 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:369:5)
          at model.save 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:609:5)
          at Object.<anonymous>.exports.crearResena (C:\Users\Kristian\Desktop\barber-saas
\backend\src\controllers\resenas.controller.js:96:9) {
        errors: {
          calificacionGeneral: ValidatorError: Path `calificacionGeneral` is required.
              at SchemaNumber.doValidate (C:\Users\Kristian\Desktop\barber-saas\backend\no
de_modules\mongoose\lib\schemaType.js:1425:13)
              at validatePath (C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\
mongoose\lib\document.js:3137:24)
              at model.$__validate (C:\Users\Kristian\Desktop\barber-saas\backend\node_mod
ules\mongoose\lib\document.js:3083:21)
              at processTicksAndRejections (node:internal/process/task_queues:105:5)
              at model.validate (C:\Users\Kristian\Desktop\barber-saas\backend\node_module
s\mongoose\lib\document.js:2663:5)
              at model.validateBeforeSave (C:\Users\Kristian\Desktop\barber-saas\backend\n
ode_modules\mongoose\lib\plugins\validateBeforeSave.js:34:7)
              at Kareem.execPre 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\kareem\index.js:65:24)
              at model.$__save 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:369:5)
              at model.save 
(C:\Users\Kristian\Desktop\barber-saas\backend\node_modules\mongoose\lib\model.js:609:5)
              at Object.<anonymous>.exports.crearResena (C:\Users\Kristian\Desktop\barber-
saas\backend\src\controllers\resenas.controller.js:96:9) {
            properties: [Object],
            kind: 'required',
            path: 'calificacionGeneral',
            value: undefined,
            reason: undefined,
            [Symbol(mongoose#validatorError)]: true
          }
        },
        _message: 'Resena validation failed'
      }

    [0m [90m 106 |[39m         })[33m;[39m
     [90m 107 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 108 |[39m         console[33m.[39merror([32m"Error al 
crear rese├▒a:"[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 109 |[39m         res[33m.[39mstatus([35m500[39m)[33m.[39mjson({ 
success[33m:[39m [36mfalse[39m[33m,[39m message[33m:[39m [32m"Error al crear la 
rese├▒a"[39m })[33m;[39m
     [90m 110 |[39m     }
     [90m 111 |[39m }[33m;[39m[0m

      at error (src/controllers/resenas.controller.js:108:17)

    console.log
      ƒôí [GET] /api/public/barberia-test/resenas/validar-token?reviewToken=f0a5dc4f751824
f1173912cfc7b397ecafb53e8a5db3b19f332ba3bbb92dfcb8

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/public/barberia-test/resenas/validar-token?reviewToken=invalid

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/public/barberia-test/resenas

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/public/barberia-test/resenas

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/admin/resenas/pendientes

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/admin/resenas/pendientes

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [PATCH] /api/admin/resenas/698a93861ca2aac760c39faa/aprobar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [PATCH] /api/admin/resenas/698a93871ca2aac760c39fbe/aprobar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/admin/resenas/estadisticas

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/public/barberia-test/resenas

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/public/barberia-2/resenas

      at log (src/app.js:98:11)

    console.warn
      ÔÜá´©Å MongoDB desconectado

    [0m [90m 89 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'disconnected'[39m[33m,[39m () 
[33m=>[39m {
     [90m 90 |[39m     isConnected [33m=[39m [36mfalse[39m[33m;[39m
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39mwarn([32m'ÔÜá´©Å MongoDB 
desconectado'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m   })[33m;[39m
     [90m 93 |[39m
     [90m 94 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'error'[39m[33m,[39m (err) 
[33m=>[39m {[0m

      at NativeConnection.warn (src/config/db.js:91:13)
      at NativeConnection.set (node_modules/mongoose/lib/connection.js:149:12)
      at NativeConnection.onClose (node_modules/mongoose/lib/connection.js:1319:19)
      at NativeConnection._close (node_modules/mongoose/lib/connection.js:1268:12)
      at Object.<anonymous> (tests/resenas.test.js:28:9)

  ÔùÅ Sistema de Rese├▒as - Tests ÔÇ║ GET /api/public/:slug/resenas/validar-token - 
Validar Token ÔÇ║ Debe validar token correcto

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

    [0m [90m 179 |[39m
     [90m 180 |[39m             
expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 181 |[39m             
expect(response[33m.[39mbody[33m.[39mvalido)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 182 |[39m         })[33m;[39m
     [90m 183 |[39m
     [90m 184 |[39m         test([32m'Debe rechazar token inv├ílido'[39m[33m,[39m 
[36masync[39m () [33m=>[39m {[0m

      at Object.toBe (tests/resenas.test.js:181:42)

  ÔùÅ Sistema de Rese├▒as - Tests ÔÇ║ GET /api/public/:slug/resenas/validar-token - 
Validar Token ÔÇ║ Debe rechazar token inv├ílido

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

    [0m [90m 187 |[39m
     [90m 188 |[39m             
expect(response[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 189 |[39m             expect(response[33m.[39mbody[33m.
[39mvalido)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 190 |[39m         })[33m;[39m
     [90m 191 |[39m     })[33m;[39m
     [90m 192 |[39m[0m

      at Object.toBe (tests/resenas.test.js:189:42)

  ÔùÅ Sistema de Rese├▒as - Tests ÔÇ║ GET /api/public/:slug/resenas - Listar Rese├▒as 
P├║blicas ÔÇ║ Debe calcular promedio correctamente

    expect(received).toBe(expected) // Object.is equality

    Expected: 4.5
    Received: undefined

    [0m [90m 242 |[39m
     [90m 243 |[39m             
expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 244 |[39m             expect(response[33m.[39mbody[33m.
[39mdata[33m.[39mpromedio)[33m.[39mtoBe([35m4.5[39m)[33m;[39m [90m// (5+4)/2[39m
     [90m     |[39m                                                 [31m[1m^[22m[39m
     [90m 245 |[39m         })[33m;[39m
     [90m 246 |[39m     })[33m;[39m
     [90m 247 |[39m[0m

      at Object.toBe (tests/resenas.test.js:244:49)

  ÔùÅ Sistema de Rese├▒as - Tests ÔÇ║ GET /api/admin/resenas/estadisticas - Estad├¡sticas 
ÔÇ║ Debe retornar estad├¡sticas correctas

    expect(received).toBeDefined()

    Received: undefined

    [0m [90m 349 |[39m             expect(response[33m.[39mbody[33m.[39mdata[33m.
[39mtotal)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m 350 |[39m             expect(response[33m.[39mbody[33m.[39mdata[33m.[39m
promedio)[33m.[39mtoBe([35m4.5[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 351 |[39m             expect(response[33m.[39mbody[33m.
[39mdata[33m.[39mporCalificacion)[33m.[39mtoBeDefined()[33m;[39m
     [90m     |[39m                                                        
[31m[1m^[22m[39m
     [90m 352 |[39m         })[33m;[39m
     [90m 353 |[39m     })[33m;[39m
     [90m 354 |[39m[0m

      at Object.toBeDefined (tests/resenas.test.js:351:56)

(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"numeroPedido":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"expiraEn":1} found. This is 
often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
[0mGET /api/public/barberia-2/resenas [32m200[0m 10.742 ms - 461[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 23.262 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 21.218 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 19.523 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 17.406 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 16.114 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 14.797 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 13.429 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 11.086 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 9.105 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar [33m404[0m 7.530 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 94.551 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 93.471 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 91.292 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 90.130 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 88.936 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 87.751 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 86.688 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 85.448 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 84.226 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 82.936 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 80.691 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 79.160 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 78.332 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 77.106 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 75.901 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 74.730 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 73.536 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 72.231 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 70.987 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 68.683 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 67.254 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 65.966 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 64.742 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 63.569 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 62.328 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 61.174 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 59.931 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 57.563 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 56.021 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 54.572 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 53.282 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 52.188 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 50.919 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 49.690 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 48.482 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 47.200 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 45.221 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 43.829 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 42.488 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 41.265 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 40.008 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 38.674 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 37.243 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 35.863 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 33.818 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 32.446 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 31.255 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 30.040 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 28.726 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar [33m404[0m 27.475 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931ad2/reservar [33m404[0m 0.870 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 44.561 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 42.835 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 40.930 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 40.190 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 37.618 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 36.076 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 34.735 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 33.812 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 32.285 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 30.624 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 29.099 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 27.552 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 25.360 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 23.772 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 22.520 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 20.977 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 18.490 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 16.841 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 15.501 ms - 207[0m
[0mPOST /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar [33m404[0m 13.662 ms - 207[0m
FAIL tests/race-condition-stress.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (13) from .env -- tip: ƒöæ add access controls to 
secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a50/reservar

      at log (src/app.js:98:11)

    console.log
      Ô£à Exitosos: 0

      at Object.log (tests/race-condition-stress.test.js:84:21)

    console.log
      ÔØî Fallidos: 10

      at Object.log (tests/race-condition-stress.test.js:85:21)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9388e9ebb22c7a931a70/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931ad2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/public/test-barberia/barberos/698a9389e9ebb22c7a931af2/reservar

      at log (src/app.js:98:11)

    console.warn
      ÔÜá´©Å MongoDB desconectado

    [0m [90m 89 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'disconnected'[39m[33m,[39m () 
[33m=>[39m {
     [90m 90 |[39m     isConnected [33m=[39m [36mfalse[39m[33m;[39m
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39mwarn([32m'ÔÜá´©Å MongoDB 
desconectado'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m   })[33m;[39m
     [90m 93 |[39m
     [90m 94 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'error'[39m[33m,[39m (err) 
[33m=>[39m {[0m

      at NativeConnection.warn (src/config/db.js:91:13)
      at NativeConnection.set (node_modules/mongoose/lib/connection.js:149:12)
      at NativeConnection.onClose (node_modules/mongoose/lib/connection.js:1319:19)
      at NativeConnection._close (node_modules/mongoose/lib/connection.js:1268:12)
      at closeDB (tests/setup.js:29:5)
      at Object.<anonymous> (tests/race-condition-stress.test.js:22:9)

  ÔùÅ ƒöÑ Race Condition Stress Tests ÔÇ║ Concurrencia Extrema ÔÇ║ 10 requests 
simult├íneos al mismo horario - solo 1 debe tener ├®xito

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 86 |[39m
     [90m 87 |[39m             [90m// Solo 1 debe tener ├®xito[39m
    [31m[1m>[22m[39m[90m 88 |[39m             
expect(successful[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m    |[39m                                       [31m[1m^[22m[39m
     [90m 89 |[39m             
expect(failed[33m.[39mlength)[33m.[39mtoBe([35m9[39m)[33m;[39m
     [90m 90 |[39m
     [90m 91 |[39m             [90m// Verificar en DB que solo hay 1 reserva[39m[0m

      at Object.toBe (tests/race-condition-stress.test.js:88:39)

  ÔùÅ ƒöÑ Race Condition Stress Tests ÔÇ║ Concurrencia Extrema ÔÇ║ 50 requests 
simult├íneos - solo 1 debe tener ├®xito

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 123 |[39m             )[33m;[39m
     [90m 124 |[39m
    [31m[1m>[22m[39m[90m 125 |[39m             
expect(successful[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                                       [31m[1m^[22m[39m
     [90m 126 |[39m
     [90m 127 |[39m             [90m// Verificar en DB[39m
     [90m 128 |[39m             [36mconst[39m count [33m=[39m [36mawait[39m 
[33mReserva[39m[33m.[39mcountDocuments({[0m

      at Object.toBe (tests/race-condition-stress.test.js:125:39)

  ÔùÅ ƒöÑ Race Condition Stress Tests ÔÇ║ Performance bajo carga ÔÇ║ Maneja 20 reservas 
diferentes simult├íneas sin problemas

    expect(received).toBeGreaterThan(expected)

    Expected: > 15
    Received:   0

    [0m [90m 253 |[39m
     [90m 254 |[39m             [90m// Todas deber├¡an tener ├®xito (diferentes 
horarios)[39m
    [31m[1m>[22m[39m[90m 255 |[39m             
expect(successful[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m15[39m)[33m;[39m 
[90m// Al menos 75% de ├®xito[39m
     [90m     |[39m                                       [31m[1m^[22m[39m
     [90m 256 |[39m
     [90m 257 |[39m             [90m// Verificar que no hay duplicados[39m
     [90m 258 |[39m             [36mconst[39m reservas [33m=[39m [36mawait[39m 
[33mReserva[39m[33m.[39mfind({[0m

      at Object.toBeGreaterThan (tests/race-condition-stress.test.js:255:39)

(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"numeroPedido":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"expiraEn":1} found. This is 
often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
[0mPOST /api/auth/login [33m400[0m 4.049 ms - 58[0m
[0mPOST /api/auth/register [33m400[0m 1.254 ms - 58[0m
[0mPOST /api/auth/login [33m401[0m 38.690 ms - 37[0m
[0mPOST /api/reservas/barberos/invalid-id/reservar [33m400[0m 1.198 ms - 58[0m
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 1.115 ms - 58[0m
FAIL tests/validation.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (13) from .env -- tip: ÔÜÖ´©Å  load multiple .env 
files with { path: ['.env.local', '.env'] }

      at _log (node_modules/dotenv/lib/main.js:142:11)

    console.log
      ­ƒôí [POST] /api/auth/login

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/auth/register

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/auth/login

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/reservas/barberos/invalid-id/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/reservas/barberos/507f1f77bcf86cd799439011/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/reservas/barberos/507f1f77bcf86cd799439011/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/barberias/test-slug/admin/servicios

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/barberias/test-slug/admin/servicios

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/reservas?barberoId%5B%24ne%5D

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/auth/login

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/reservas/barberos/507f1f77bcf86cd799439011/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/reservas/barberos/507f1f77bcf86cd799439011/reservar

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/auth/register

      at log (src/app.js:98:11)

  ÔùÅ Input Validation Tests ÔÇ║ Auth Validation ÔÇ║ should reject invalid email format

    expect(received).toEqual(expected) // deep equality

    Expected: ArrayContaining [ObjectContaining {"field": "email"}]
    Received: []

    [0m [90m 15 |[39m             
expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 16 |[39m             
expect(res[33m.[39mbody[33m.[39mmessage)[33m.[39mtoBe([32m'Validation 
error'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 17 |[39m             
expect(res[33m.[39mbody[33m.[39merrors)[33m.[39mtoEqual(
     [90m    |[39m                                     [31m[1m^[22m[39m
     [90m 18 |[39m                 expect[33m.[39marrayContaining([
     [90m 19 |[39m                     expect[33m.[39mobjectContaining({
     [90m 20 |[39m                         field[33m:[39m [32m'email'[39m[0m

      at Object.toEqual (tests/validation.test.js:17:37)

  ÔùÅ Input Validation Tests ÔÇ║ Auth Validation ÔÇ║ should reject weak password on 
registration

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

    [0m [90m 35 |[39m
     [90m 36 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 37 |[39m             expect(res[33m.[39mbody[33m.[39mer
rors[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m
     [90m    |[39m                                            [31m[1m^[22m[39m
     [90m 38 |[39m         })[33m;[39m
     [90m 39 |[39m
     [90m 40 |[39m         it([32m'should accept valid login data'[39m[33m,[39m 
[36masync[39m () [33m=>[39m {[0m

      at Object.toBeGreaterThan (tests/validation.test.js:37:44)

  ÔùÅ Input Validation Tests ÔÇ║ Reserva Validation ÔÇ║ should reject invalid ObjectId 
format

    expect(received).toEqual(expected) // deep equality

    Expected: ArrayContaining [ObjectContaining {"field": "barberoId", "message": 
StringContaining "Invalid ObjectId"}]
    Received: []

    [0m [90m 65 |[39m
     [90m 66 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 67 |[39m             
expect(res[33m.[39mbody[33m.[39merrors)[33m.[39mtoEqual(
     [90m    |[39m                                     [31m[1m^[22m[39m
     [90m 68 |[39m                 expect[33m.[39marrayContaining([
     [90m 69 |[39m                     expect[33m.[39mobjectContaining({
     [90m 70 |[39m                         field[33m:[39m 
[32m'barberoId'[39m[33m,[39m[0m

      at Object.toEqual (tests/validation.test.js:67:37)

  ÔùÅ Input Validation Tests ÔÇ║ Reserva Validation ÔÇ║ should reject past dates

    expect(received).toEqual(expected) // deep equality

    Expected: ArrayContaining [ObjectContaining {"field": "fecha"}]
    Received: []

    [0m [90m 87 |[39m
     [90m 88 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 89 |[39m             
expect(res[33m.[39mbody[33m.[39merrors)[33m.[39mtoEqual(
     [90m    |[39m                                     [31m[1m^[22m[39m
     [90m 90 |[39m                 expect[33m.[39marrayContaining([
     [90m 91 |[39m                     expect[33m.[39mobjectContaining({
     [90m 92 |[39m                         field[33m:[39m [32m'fecha'[39m[0m

      at Object.toEqual (tests/validation.test.js:89:37)

  ÔùÅ Input Validation Tests ÔÇ║ Servicio Validation ÔÇ║ should reject negative price

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 122 |[39m                 })[33m;[39m
     [90m 123 |[39m
    [31m[1m>[22m[39m[90m 124 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 125 |[39m             
expect(res[33m.[39mbody[33m.[39merrors)[33m.[39mtoEqual(
     [90m 126 |[39m                 expect[33m.[39marrayContaining([
     [90m 127 |[39m                     expect[33m.[39mobjectContaining({[0m

      at Object.toBe (tests/validation.test.js:124:32)

  ÔùÅ Input Validation Tests ÔÇ║ Servicio Validation ÔÇ║ should reject invalid duration

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 142 |[39m                 })[33m;[39m
     [90m 143 |[39m
    [31m[1m>[22m[39m[90m 144 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 145 |[39m         })[33m;[39m
     [90m 146 |[39m     })[33m;[39m
     [90m 147 |[39m })[33m;[39m[0m

      at Object.toBe (tests/validation.test.js:144:32)

  ÔùÅ Error Message Quality ÔÇ║ should provide clear field-level errors

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

    [0m [90m 217 |[39m
     [90m 218 |[39m         
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 219 |[39m         expect(res[33m.[39mbody[33m.[39merror
s[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m
     [90m     |[39m                                        [31m[1m^[22m[39m
     [90m 220 |[39m
     [90m 221 |[39m         [90m// Each error should have field and message[39m
     [90m 222 |[39m         res[33m.[39mbody[33m.[39merrors[33m.[39mforEach(error 
[33m=>[39m {[0m

      at Object.toBeGreaterThan (tests/validation.test.js:219:40)

(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"numeroPedido":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"expiraEn":1} found. This is 
often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 0.733 ms - 58[0m
[0mPOST /api/barberias/test-slug/admin/servicios [33m401[0m 0.349 ms - 27[0m
[0mPOST /api/barberias/test-slug/admin/servicios [33m401[0m 0.306 ms - 27[0m
[0mGET /api/reservas?barberoId%5B%24ne%5D [33m401[0m 0.199 ms - 27[0m
[0mPOST /api/auth/login [33m400[0m 0.843 ms - 58[0m
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 0.671 ms - 58[0m
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 0.735 ms - 58[0m
[0mPOST /api/auth/register [33m400[0m 0.880 ms - 58[0m
FAIL tests/reservas_atomicas.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (13) from .env -- tip: ÔÜÖ´©Å  write to custom object 
with { processEnv: myObject }

      at _log (node_modules/dotenv/lib/main.js:142:11)

    console.log
      ƒôí [POST] 
/api/public/barberias/atomic-shop/barberos/698a938ba86c94c2e705405b/reservar

      at log (src/app.js:98:11)

    console.log
      [Transaction] Started: CreateReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: CreateReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: CreateReservation {
        error: 'El horario seleccionado ya no est├í disponible. Por favor, elige otro 
horario.',
        attempt: 1,
        stack: 'ReservationConflictError: El horario seleccionado ya no est├í disponible. 
Por favor, elige otro horario.\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js
:49:31)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backen
d\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
          '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desk
top\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CreateReserva.execute (src/application/use-cases/reservas/CreateReserva.js:26:34)
      at Object.<anonymous>.exports.crearReservaBySlug 
(src/controllers/public.controller.js:140:25)

    console.error
      ƒö┤ ERROR: TransactionError: Transaction failed for CreateReservation: El horario 
seleccionado ya no est├í disponible. Por favor, elige otro horario.
          at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\appl
ication\use-cases\reservas\CreateReserva.js:26:34)
          at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\barb
er-saas\backend\src\controllers\public.controller.js:140:25) {
        isTransactionError: true,
        originalError: ReservationConflictError: El horario seleccionado ya no est├í 
disponible. Por favor, elige otro horario.
            at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\De
sktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:49:31)
            at processTicksAndRejections (node:internal/process/task_queues:105:5)
            at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
            at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\ap
plication\use-cases\reservas\CreateReserva.js:26:34)
            at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\ba
rber-saas\backend\src\controllers\public.controller.js:140:25) {
          statusCode: 409,
          userFriendly: true
        },
        context: { operationName: 'CreateReservation', attempt: 1 },
        timestamp: 2026-02-10T02:10:19.081Z,
        originalStack: 'ReservationConflictError: El horario seleccionado ya no est├í 
disponible. Por favor, elige otro horario.\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js
:49:31)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backen
d\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
          '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desk
top\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)',
        statusCode: 409
      }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m 
req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"ƒö┤ 
ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m 
req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at Immediate.next (node_modules/router/index.js:291:5)
      at Immediate._onImmediate (node_modules/router/index.js:688:15)

    console.log
      DEBUG res1: 409 {
        success: false,
        error: {
          message: 'Transaction failed for CreateReservation: El horario seleccionado ya 
no est├í disponible. Por favor, elige otro horario.',
          type: 'TransactionError',
          stack: 'TransactionError: Transaction failed for CreateReservation: El horario 
seleccionado ya no est├í disponible. Por favor, elige otro horario.\n' +
            '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-sa
as\\backend\\src\\utils\\TransactionManager.js:88:42)\n' +
            '    at processTicksAndRejections 
(node:internal/process/task_queues:105:5)\n' +
            '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\back
end\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
            '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\De
sktop\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)'
        }
      }

      at Object.log (tests/reservas_atomicas.test.js:65:42)

    console.log
      ƒôí [POST] 
/api/public/barberias/atomic-shop/barberos/698a938ba86c94c2e705405b/reservar

      at log (src/app.js:98:11)

    console.log
      [Transaction] Started: CreateReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: CreateReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: CreateReservation {
        error: 'El horario seleccionado ya no est├í disponible. Por favor, elige otro 
horario.',
        attempt: 1,
        stack: 'ReservationConflictError: El horario seleccionado ya no est├í disponible. 
Por favor, elige otro horario.\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js
:49:31)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backen
d\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
          '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desk
top\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CreateReserva.execute (src/application/use-cases/reservas/CreateReserva.js:26:34)
      at Object.<anonymous>.exports.crearReservaBySlug 
(src/controllers/public.controller.js:140:25)

    console.error
      ƒö┤ ERROR: TransactionError: Transaction failed for CreateReservation: El horario 
seleccionado ya no est├í disponible. Por favor, elige otro horario.
          at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\appl
ication\use-cases\reservas\CreateReserva.js:26:34)
          at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\barb
er-saas\backend\src\controllers\public.controller.js:140:25) {
        isTransactionError: true,
        originalError: ReservationConflictError: El horario seleccionado ya no est├í 
disponible. Por favor, elige otro horario.
            at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\De
sktop\barber-saas\backend\src\application\use-cases\reservas\CreateReserva.js:49:31)
            at processTicksAndRejections (node:internal/process/task_queues:105:5)
            at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
            at CreateReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\ap
plication\use-cases\reservas\CreateReserva.js:26:34)
            at Object.<anonymous>.exports.crearReservaBySlug (C:\Users\Kristian\Desktop\ba
rber-saas\backend\src\controllers\public.controller.js:140:25) {
          statusCode: 409,
          userFriendly: true
        },
        context: { operationName: 'CreateReservation', attempt: 1 },
        timestamp: 2026-02-10T02:10:19.099Z,
        originalStack: 'ReservationConflictError: El horario seleccionado ya no est├í 
disponible. Por favor, elige otro horario.\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CreateReserva.js
:49:31)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CreateReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backen
d\\src\\application\\use-cases\\reservas\\CreateReserva.js:26:34)\n' +
          '    at Object.<anonymous>.exports.crearReservaBySlug (C:\\Users\\Kristian\\Desk
top\\barber-saas\\backend\\src\\controllers\\public.controller.js:140:25)',
        statusCode: 409
      }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m 
req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"ƒö┤ 
ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m 
req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at Immediate.next (node_modules/router/index.js:291:5)
      at Immediate._onImmediate (node_modules/router/index.js:688:15)

    console.warn
      ÔÜá´©Å MongoDB desconectado

    [0m [90m 89 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'disconnected'[39m[33m,[39m () 
[33m=>[39m {
     [90m 90 |[39m     isConnected [33m=[39m [36mfalse[39m[33m;[39m
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39mwarn([32m'ÔÜá´©Å MongoDB 
desconectado'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m   })[33m;[39m
     [90m 93 |[39m
     [90m 94 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'error'[39m[33m,[39m (err) 
[33m=>[39m {[0m

      at NativeConnection.warn (src/config/db.js:91:13)
      at NativeConnection.set (node_modules/mongoose/lib/connection.js:149:12)
      at NativeConnection.onClose (node_modules/mongoose/lib/connection.js:1319:19)
      at NativeConnection._close (node_modules/mongoose/lib/connection.js:1268:12)
      at Object.<anonymous> (tests/reservas_atomicas.test.js:48:9)

  ÔùÅ Pruebas de Atomicidad de Reservas (Anti-Overbooking) ÔÇ║ No debe permitir dos 
reservas en el mismo horario (Previene Overbooking)

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 409

    [0m [90m 64 |[39m
     [90m 65 |[39m         [36mif[39m (res1[33m.[39mstatus [33m!==[39m 
[35m201[39m) console[33m.[39mlog([32m'DEBUG res1:'[39m[33m,[39m 
res1[33m.[39mstatus[33m,[39m res1[33m.[39mbody)[33m;[39m
    [31m[1m>[22m[39m[90m 66 |[39m         
expect(res1[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 67 |[39m         expect(res1[33m.[39mbody[33m.[39mmessage)[33m.[39mtoCon
tain([32m'correctamente'[39m)[33m;[39m
     [90m 68 |[39m
     [90m 69 |[39m         [90m// 2. Intentar crear exactamente la misma 
reserva[39m[0m

      at Object.toBe (tests/reservas_atomicas.test.js:66:29)

  ÔùÅ Pruebas de Atomicidad de Reservas (Anti-Overbooking) ÔÇ║ Debe permitir reservar si 
la cita anterior fue CANCELADA

    TypeError: Cannot read properties of undefined (reading '_id')

    [0m [90m 100 |[39m             [33m.[39msend(payload)[33m;[39m
     [90m 101 |[39m
    [31m[1m>[22m[39m[90m 102 |[39m         [36mconst[39m reservaId [33m=[39m 
res1[33m.[39mbody[33m.[39mreserva[33m.[39m_id[33m;[39m
     [90m     |[39m                                             [31m[1m^[22m[39m
     [90m 103 |[39m
     [90m 104 |[39m         [90m// 2. Cancelar la reserva[39m
     [90m 105 |[39m         [36mawait[39m 
[33mReserva[39m[33m.[39mfindByIdAndUpdate(reservaId[33m,[39m { estado[33m:[39m 
[32m'CANCELADA'[39m })[33m;[39m[0m

      at Object._id (tests/reservas_atomicas.test.js:102:45)

(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
[0mPOST /api/public/barberias/atomic-shop/barberos/698a938ba86c94c2e705405b/reservar [33m409[0m 16.732 ms - 843[0m
[0mPOST /api/public/barberias/atomic-shop/barberos/698a938ba86c94c2e705405b/reservar [33m409[0m 8.386 ms - 843[0m
FAIL tests/transaction-rollback.test.js
  ÔùÅ Console

    console.log
      [Transaction] Started: CompleteReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: CompleteReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: CompleteReservation {
        error: 'barberiaId es requerido para el aislamiento de datos',
        attempt: 1,
        stack: 'Error: barberiaId es requerido para el aislamiento de datos\n' +
          '    at MongoReservaRepository.findById (C:\\Users\\Kristian\\Desktop\\barber-sa
as\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.
js:23:19)\n' +
          '    at findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\appli
cation\\use-cases\\reservas\\CompleteReserva.js:27:62)\n' +
          '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Deskt
op\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\back
end\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
          '    at Object.<anonymous> (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\
tests\\transaction-rollback.test.js:82:13)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CompleteReserva.execute 
(src/application/use-cases/reservas/CompleteReserva.js:24:24)
      at Object.<anonymous> (tests/transaction-rollback.test.js:82:13)

    console.log
      [Transaction] Started: CompleteReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: CompleteReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: CompleteReservation {
        error: 'barberiaId es requerido para el aislamiento de datos',
        attempt: 1,
        stack: 'Error: barberiaId es requerido para el aislamiento de datos\n' +
          '    at MongoReservaRepository.findById (C:\\Users\\Kristian\\Desktop\\barber-sa
as\\backend\\src\\infrastructure\\database\\mongodb\\repositories\\MongoReservaRepository.
js:23:19)\n' +
          '    at findById (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\src\\appli
cation\\use-cases\\reservas\\CompleteReserva.js:27:62)\n' +
          '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Deskt
op\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\back
end\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
          '    at Object.<anonymous> (C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\
tests\\transaction-rollback.test.js:138:28)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CompleteReserva.execute 
(src/application/use-cases/reservas/CompleteReserva.js:24:24)
      at Object.<anonymous> (tests/transaction-rollback.test.js:138:28)

  ÔùÅ Transaction Rollback Integration Tests ÔÇ║ CompleteReserva Transaction Rollback ÔÇ║ 
should rollback reservation update if client update fails

    expect(received).toBe(expected) // Object.is equality

    Expected: 0
    Received: undefined

    [0m [90m 91 |[39m             [90m// 6. Verify client visit count unchanged[39m
     [90m 92 |[39m             [36mconst[39m clienteAfter [33m=[39m [36mawait[39m 
[33mUserModel[39m[33m.[39mfindById(cliente[33m.[39m_id)[33m;[39m
    [31m[1m>[22m[39m[90m 93 |[39m             
expect(clienteAfter[33m.[39mhistorialVisitas)[33m.[39mtoBe([35m0[39m)[33m;[39m
     [90m    |[39m                                                   
[31m[1m^[22m[39m
     [90m 94 |[39m
     [90m 95 |[39m             [90m// Restore original method[39m
     [90m 96 |[39m             clienteRepository[33m.[39mupdate [33m=[39m 
originalUpdate[33m;[39m[0m

      at Object.toBe (tests/transaction-rollback.test.js:93:51)

  ÔùÅ Transaction Rollback Integration Tests ÔÇ║ CompleteReserva Transaction Rollback ÔÇ║ 
should commit both updates when successful

    TransactionError: Transaction failed for CompleteReservation: barberiaId es requerido 
para el aislamiento de datos

    [0m [90m 86 |[39m                 })[33m;[39m
     [90m 87 |[39m
    [31m[1m>[22m[39m[90m 88 |[39m                 [36mconst[39m transactionError 
[33m=[39m [36mnew[39m [33mTransactionError[39m(
     [90m    |[39m                                          [31m[1m^[22m[39m
     [90m 89 |[39m                     [32m`Transaction failed for ${operationName}: 
${error.message}`[39m[33m,[39m
     [90m 90 |[39m                     error[33m,[39m
     [90m 91 |[39m                     { operationName[33m,[39m attempt[33m:[39m 
attempt [33m+[39m [35m1[39m }[0m

      at Function.executeInTransaction (src/utils/TransactionManager.js:88:42)
      at CompleteReserva.execute 
(src/application/use-cases/reservas/CompleteReserva.js:24:24)
      at Object.<anonymous> (tests/transaction-rollback.test.js:138:28)

(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"numeroPedido":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"expiraEn":1} found. This is 
often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
(node:26752) [MONGOOSE] Warning: Duplicate schema index on {"reviewToken":1} found. This 
is often due to declaring an index using both "index: true" and "schema.index()". Please 
remove the duplicate index definition.
[0mGET /api/reservas/698a938c93fbb72d468e89a7 [33m404[0m 8.189 ms - 35[0m
[0mPATCH /api/reservas/698a938c93fbb72d468e89d5/completar [33m404[0m 10.186 ms - 736[0m
[0mPATCH /api/reservas/698a938c93fbb72d468e8a03/cancelar [33m404[0m 7.809 ms - 727[0m
[0mGET /api/reservas [32m200[0m 14.996 ms - 243[0m
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 10.162 ms - 74[0m
[0mPOST /api/barberias/test-barberia-b/admin/servicios [33m403[0m 6.652 ms - 74[0m
[0mPUT /api/barberias/test-barberia-b/admin/servicios/698a938d93fbb72d468e8ab9 [33m403[0m 6.718 ms - 74[0m
[0mGET /api/barberias/test-barberia-b/barbero [33m403[0m 7.062 ms - 74[0m
[0mPOST /api/barberias/test-barberia-b/barbero [33m403[0m 6.917 ms - 74[0m
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 8.539 ms - 74[0m
[0mGET /api/barberias/slug-inexistente/admin/servicios [33m404[0m 5.769 ms - 37[0m
[0mGET /api/reservas?barberiaId=698a938e93fbb72d468e8b93 [32m200[0m 13.611 ms - 243[0m
[0mPOST /api/barberias/test-barberia-a/admin/servicios [32m201[0m 16.088 ms - 324[0m
[0mGET /api/reservas/698a938e93fbb72d468e8c04 [32m200[0m 10.970 ms - 218[0m
[0mGET /api/barberias/test-barberia-a/admin/servicios [32m200[0m 15.660 ms - 257[0m
[0mGET /api/barberias/test-barberia-b/admin/servicios [32m200[0m 13.913 ms - 257[0m
[0mGET /api/barberias/test-barberia-b/admin/servicios [33m403[0m 7.711 ms - 74[0m
PASS tests/multi-tenant-security.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (13) from .env -- tip: ƒöä add secrets lifecycle 
management: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

    console.log
      ­ƒôí [GET] /api/reservas/698a938c93fbb72d468e89a7

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [PATCH] /api/reservas/698a938c93fbb72d468e89d5/completar

      at log (src/app.js:98:11)

    console.log
      [Transaction] Started: CompleteReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: CompleteReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: CompleteReservation {
        error: 'Reserva no encontrada',
        attempt: 1,
        stack: 'Error: Reserva no encontrada\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.
js:30:35)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\back
end\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
          '    at Object.<anonymous>.exports.completarReserva (C:\\Users\\Kristian\\Deskto
p\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:92:25)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CompleteReserva.execute 
(src/application/use-cases/reservas/CompleteReserva.js:24:24)
      at Object.<anonymous>.exports.completarReserva 
(src/controllers/reservas.controller.js:92:25)

    console.error
      ƒö┤ ERROR: TransactionError: Transaction failed for CompleteReservation: Reserva no 
encontrada
          at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at CompleteReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\ap
plication\use-cases\reservas\CompleteReserva.js:24:24)
          at Object.<anonymous>.exports.completarReserva (C:\Users\Kristian\Desktop\barber
-saas\backend\src\controllers\reservas.controller.js:92:25) {
        isTransactionError: true,
        originalError: Error: Reserva no encontrada
            at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\De
sktop\barber-saas\backend\src\application\use-cases\reservas\CompleteReserva.js:30:35)
            at processTicksAndRejections (node:internal/process/task_queues:105:5)
            at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
            at CompleteReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\
application\use-cases\reservas\CompleteReserva.js:24:24)
            at Object.<anonymous>.exports.completarReserva (C:\Users\Kristian\Desktop\barb
er-saas\backend\src\controllers\reservas.controller.js:92:25) {
          statusCode: 404
        },
        context: { operationName: 'CompleteReservation', attempt: 1 },
        timestamp: 2026-02-10T02:10:20.566Z,
        originalStack: 'Error: Reserva no encontrada\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CompleteReserva.
js:30:35)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CompleteReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\back
end\\src\\application\\use-cases\\reservas\\CompleteReserva.js:24:24)\n' +
          '    at Object.<anonymous>.exports.completarReserva (C:\\Users\\Kristian\\Deskto
p\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:92:25)',
        statusCode: 404
      }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m 
req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"ƒö┤ 
ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m 
req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/reservas.controller.js:102:9)

    console.log
      ­ƒôí [PATCH] /api/reservas/698a938c93fbb72d468e8a03/cancelar

      at log (src/app.js:98:11)

    console.log
      [Transaction] Started: CancelReservation (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: CancelReservation

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: CancelReservation {
        error: 'Reserva no encontrada',
        attempt: 1,
        stack: 'Error: Reserva no encontrada\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js
:28:35)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CancelReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backen
d\\src\\application\\use-cases\\reservas\\CancelReserva.js:22:25)\n' +
          '    at Object.<anonymous>.exports.cancelarReserva (C:\\Users\\Kristian\\Desktop
\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:45:25)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at CancelReserva.execute (src/application/use-cases/reservas/CancelReserva.js:22:25)
      at Object.<anonymous>.exports.cancelarReserva 
(src/controllers/reservas.controller.js:45:25)

    console.error
      ƒö┤ ERROR: TransactionError: Transaction failed for CancelReservation: Reserva no 
encontrada
          at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:88:42)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at CancelReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\appl
ication\use-cases\reservas\CancelReserva.js:22:25)
          at Object.<anonymous>.exports.cancelarReserva (C:\Users\Kristian\Desktop\barber-
saas\backend\src\controllers\reservas.controller.js:45:25) {
        isTransactionError: true,
        originalError: Error: Reserva no encontrada
            at TransactionManager.executeInTransaction.operationName (C:\Users\Kristian\De
sktop\barber-saas\backend\src\application\use-cases\reservas\CancelReserva.js:28:35)
            at processTicksAndRejections (node:internal/process/task_queues:105:5)
            at Function.executeInTransaction 
(C:\Users\Kristian\Desktop\barber-saas\backend\src\utils\TransactionManager.js:57:32)
            at CancelReserva.execute (C:\Users\Kristian\Desktop\barber-saas\backend\src\ap
plication\use-cases\reservas\CancelReserva.js:22:25)
            at Object.<anonymous>.exports.cancelarReserva (C:\Users\Kristian\Desktop\barbe
r-saas\backend\src\controllers\reservas.controller.js:45:25) {
          statusCode: 404
        },
        context: { operationName: 'CancelReservation', attempt: 1 },
        timestamp: 2026-02-10T02:10:20.753Z,
        originalStack: 'Error: Reserva no encontrada\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\src\\application\\use-cases\\reservas\\CancelReserva.js
:28:35)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Function.executeInTransaction (C:\\Users\\Kristian\\Desktop\\barber-saas
\\backend\\src\\utils\\TransactionManager.js:57:32)\n' +
          '    at CancelReserva.execute (C:\\Users\\Kristian\\Desktop\\barber-saas\\backen
d\\src\\application\\use-cases\\reservas\\CancelReserva.js:22:25)\n' +
          '    at Object.<anonymous>.exports.cancelarReserva (C:\\Users\\Kristian\\Desktop
\\barber-saas\\backend\\src\\controllers\\reservas.controller.js:45:25)',
        statusCode: 404
      }

    [0m [90m 4 |[39m
     [90m 5 |[39m [36mconst[39m errorHandler [33m=[39m (err[33m,[39m 
req[33m,[39m res[33m,[39m next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror([32m"ƒö┤ 
ERROR:"[39m[33m,[39m err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// ­ƒöÑ A├æADIR HEADERS CORS SI NO EXISTEN[39m
     [90m 9 |[39m   [36mconst[39m origin [33m=[39m 
req[33m.[39mheaders[33m.[39morigin[33m;[39m[0m

      at error (src/config/middleware/errorHandler.js:6:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/reservas.controller.js:57:9)

    console.log
      ­ƒôí [GET] /api/reservas

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

    console.log
      [33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedB
arberiaId":"698a938c93fbb72d468e8a51","timestamp":"2026-02-10T02:10:21.125Z","url":"/api/b
arberias/test-barberia-b/admin/servicios","userBarberiaId":"698a938c93fbb72d468e8a4f","use
rId":"698a938c93fbb72d468e8a53"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [POST] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

    console.log
      [33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"POST","requested
BarberiaId":"698a938d93fbb72d468e8a7f","timestamp":"2026-02-10T02:10:21.314Z","url":"/api/
barberias/test-barberia-b/admin/servicios","userBarberiaId":"698a938d93fbb72d468e8a7d","us
erId":"698a938d93fbb72d468e8a81"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [PUT] /api/barberias/test-barberia-b/admin/servicios/698a938d93fbb72d468e8ab9

      at log (src/app.js:98:11)

    console.log
      [33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"PUT","requestedB
arberiaId":"698a938d93fbb72d468e8aad","timestamp":"2026-02-10T02:10:21.499Z","url":"/api/b
arberias/test-barberia-b/admin/servicios/698a938d93fbb72d468e8ab9","userBarberiaId":"698a9
38d93fbb72d468e8aab","userId":"698a938d93fbb72d468e8aaf"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-b/barbero

      at log (src/app.js:98:11)

    console.log
      [33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedB
arberiaId":"698a938d93fbb72d468e8adb","timestamp":"2026-02-10T02:10:21.681Z","url":"/api/b
arberias/test-barberia-b/barbero","userBarberiaId":"698a938d93fbb72d468e8ad9","userId":"69
8a938d93fbb72d468e8add"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [POST] /api/barberias/test-barberia-b/barbero

      at log (src/app.js:98:11)

    console.log
      [33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"POST","requested
BarberiaId":"698a938d93fbb72d468e8b09","timestamp":"2026-02-10T02:10:21.866Z","url":"/api/
barberias/test-barberia-b/barbero","userBarberiaId":"698a938d93fbb72d468e8b07","userId":"6
98a938d93fbb72d468e8b0b"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

    console.log
      [33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedB
arberiaId":"698a938d93fbb72d468e8b37","timestamp":"2026-02-10T02:10:22.066Z","url":"/api/b
arberias/test-barberia-b/admin/servicios","userBarberiaId":"698a938d93fbb72d468e8b35","use
rId":"698a938d93fbb72d468e8b39"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [GET] /api/barberias/slug-inexistente/admin/servicios

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/reservas?barberiaId=698a938e93fbb72d468e8b93

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [POST] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/reservas/698a938e93fbb72d468e8c04

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

    console.log
      [33mwarn[39m: Intento de acceso cross-tenant bloqueado {"method":"GET","requestedB
arberiaId":"698a938f93fbb72d468e8c88","timestamp":"2026-02-10T02:10:23.421Z","url":"/api/b
arberias/test-barberia-b/admin/servicios","userBarberiaId":"698a938f93fbb72d468e8c86","use
rId":"698a938f93fbb72d468e8c8a"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-a/admin/servicios

      at log (src/app.js:98:11)

    console.log
      [32minfo[39m: Acceso SUPER_ADMIN permitido {"barberiaId":"698a938f93fbb72d468e8cb4
","timestamp":"2026-02-10T02:10:23.662Z","userId":"698a938f93fbb72d468e8cc8"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.log
      ­ƒôí [GET] /api/barberias/test-barberia-b/admin/servicios

      at log (src/app.js:98:11)

    console.log
      [32minfo[39m: Acceso SUPER_ADMIN permitido {"barberiaId":"698a938f93fbb72d468e8cb6
","timestamp":"2026-02-10T02:10:23.684Z","userId":"698a938f93fbb72d468e8cc8"}

      at Console.log (node_modules/winston/lib/winston/transports/console.js:87:23)

    console.warn
      ÔÜá´©Å MongoDB desconectado

    [0m [90m 89 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'disconnected'[39m[33m,[39m () 
[33m=>[39m {
     [90m 90 |[39m     isConnected [33m=[39m [36mfalse[39m[33m;[39m
    [31m[1m>[22m[39m[90m 91 |[39m     console[33m.[39mwarn([32m'ÔÜá´©Å MongoDB 
desconectado'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 92 |[39m   })[33m;[39m
     [90m 93 |[39m
     [90m 94 |[39m   
mongoose[33m.[39mconnection[33m.[39mon([32m'error'[39m[33m,[39m (err) 
[33m=>[39m {[0m

      at NativeConnection.warn (src/config/db.js:91:13)
      at NativeConnection.set (node_modules/mongoose/lib/connection.js:149:12)
      at NativeConnection.onClose (node_modules/mongoose/lib/connection.js:1319:19)
      at NativeConnection._close (node_modules/mongoose/lib/connection.js:1268:12)
      at closeDB (tests/setup.js:29:5)
      at Object.<anonymous> (tests/multi-tenant-security.test.js:24:9)

[0mGET /api/barberias/test-barberia-a/admin/servicios [32m200[0m 14.428 ms - 257[0m
[0mGET /api/barberias/test-barberia-b/admin/servicios [32m200[0m 14.249 ms - 257[0m
PASS tests/transactions.test.js
  ÔùÅ Console

    console.log
      [Transaction] Started: TestSuccessfulTransaction (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Committed: TestSuccessfulTransaction

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:61:25)

    console.log
      [Transaction] Started: TestRollback (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: TestRollback

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: TestRollback {
        error: 'Simulated error',
        attempt: 1,
        stack: 'Error: Simulated error\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\tests\\transactions.test.js:34:31)\n' +
          '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Deskt
op\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
          '    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n' +
          '    at Object.<anonymous> 
(C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\tests\\transactions.test.js:31:13)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at Object.<anonymous> (tests/transactions.test.js:31:13)

    console.log
      [Transaction] Started: TestRetry (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: TestRetry

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.warn
      [Transaction] Transient error, retrying in 200ms: WriteConflict

    [0m [90m 74 |[39m                     attempt[33m++[39m[33m;[39m
     [90m 75 |[39m                     [36mconst[39m delay [33m=[39m retryDelay 
[33m*[39m [33mMath[39m[33m.[39mpow([35m2[39m[33m,[39m attempt)[33m;[39m 
[90m// Exponential backoff[39m
    [31m[1m>[22m[39m[90m 76 |[39m                     
console[33m.[39mwarn([32m`[Transaction] Transient error, retrying in 
${delay}ms:`[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 77 |[39m                     [36mawait[39m 
[36mthis[39m[33m.[39msleep(delay)[33m;[39m
     [90m 78 |[39m                     [36mcontinue[39m[33m;[39m
     [90m 79 |[39m                 }[0m

      at Function.warn [as executeInTransaction] (src/utils/TransactionManager.js:76:29)
      at Object.<anonymous> (tests/transactions.test.js:44:28)

    console.log
      [Transaction] Started: TestRetry (attempt 2/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Committed: TestRetry

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:61:25)

    console.log
      [Transaction] Started: TestNoRetry (attempt 1/3)

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:54:25)

    console.log
      [Transaction] Aborted: TestNoRetry

      at Function.log [as executeInTransaction] (src/utils/TransactionManager.js:69:29)

    console.error
      [Transaction] Failed: TestNoRetry {
        error: 'Reserva no encontrada',
        attempt: 1,
        stack: 'Error: Reserva no encontrada\n' +
          '    at TransactionManager.executeInTransaction.operationName (C:\\Users\\Kristi
an\\Desktop\\barber-saas\\backend\\tests\\transactions.test.js:69:31)\n' +
          '    at Function.operation [as executeInTransaction] (C:\\Users\\Kristian\\Deskt
op\\barber-saas\\backend\\src\\utils\\TransactionManager.js:57:38)\n' +
          '    at runNextTicks (node:internal/process/task_queues:65:5)\n' +
          '    at processTimers (node:internal/timers:520:9)\n' +
          '    at Object.<anonymous> 
(C:\\Users\\Kristian\\Desktop\\barber-saas\\backend\\tests\\transactions.test.js:65:13)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m                 [90m// Non-transient error or max retries 
reached[39m
    [31m[1m>[22m[39m[90m 82 |[39m                 
console[33m.[39merror([32m`[Transaction] Failed: ${operationName}`[39m[33m,[39m {
     [90m    |[39m                         [31m[1m^[22m[39m
     [90m 83 |[39m                     error[33m:[39m 
error[33m.[39mmessage[33m,[39m
     [90m 84 |[39m                     attempt[33m:[39m attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m                     stack[33m:[39m error[33m.[39mstack[0m

      at Function.error [as executeInTransaction] (src/utils/TransactionManager.js:82:25)
      at Object.<anonymous> (tests/transactions.test.js:65:13)

    console.log
      Ô£à MongoDB transactions are supported

      at Function.log [as validateTransactionSupport] 
(src/utils/TransactionManager.js:192:21)

PASS tests/revenue.test.js

Test Suites: 5 failed, 3 passed, 8 total
Tests:       18 failed, 56 passed, 74 total
Snapshots:   0 total
Time:        13.285 s, estimated 14 s
Ran all test suites.

Jest has detected the following 1 open handle potentially keeping Jest from exiting:

  ÔùÅ  TCPWRAP

    [0m [90m 43 |[39m     [36mawait[39m retryDatabaseOperation(
     [90m 44 |[39m       [36masync[39m () [33m=>[39m {
    [31m[1m>[22m[39m[90m 45 |[39m         [36mawait[39m 
mongoose[33m.[39mconnect(uri[33m,[39m options)[33m;[39m
     [90m    |[39m                        [31m[1m^[22m[39m
     [90m 46 |[39m       }[33m,[39m
     [90m 47 |[39m       [32m'MongoDB Connection'[39m
     [90m 48 |[39m     )[33m;[39m[0m

      at makeSocket (node_modules/mongodb/src/cmap/connect.ts:379:18)
      at node_modules/mongodb/src/sdam/monitor.ts:383:36
      at checkServer (node_modules/mongodb/src/sdam/monitor.ts:394:5)
      at MonitorInterval.fn (node_modules/mongodb/src/sdam/monitor.ts:441:5)
      at MonitorInterval._executeAndReschedule 
(node_modules/mongodb/src/sdam/monitor.ts:686:10)
      at new MonitorInterval (node_modules/mongodb/src/sdam/monitor.ts:603:12)
      at Monitor.connect (node_modules/mongodb/src/sdam/monitor.ts:160:22)
      at Server.connect (node_modules/mongodb/src/sdam/server.ts:243:21)
      at createAndConnectServer (node_modules/mongodb/src/sdam/topology.ts:844:10)
      at node_modules/mongodb/src/sdam/topology.ts:432:9
          at Array.map (<anonymous>)
      at Topology._connect (node_modules/mongodb/src/sdam/topology.ts:430:26)
      at Topology.connect (node_modules/mongodb/src/sdam/topology.ts:397:34)
      at topologyConnect (node_modules/mongodb/src/mongo_client.ts:662:30)
      at MongoClient._connect (node_modules/mongodb/src/mongo_client.ts:674:13)
      at MongoClient.connect (node_modules/mongodb/src/mongo_client.ts:585:34)
      at NativeConnection.createClient 
(node_modules/mongoose/lib/drivers/node-mongodb-native/connection.js:344:16)
      at NativeConnection.openUri (node_modules/mongoose/lib/connection.js:1075:34)
      at Mongoose.connect (node_modules/mongoose/lib/mongoose.js:451:15)
      at connect (src/config/db.js:45:24)
      at fn (src/utils/retry.js:36:26)
      at retryWithBackoff (src/utils/retry.js:89:12)
      at retryDatabaseOperation (src/config/db.js:43:11)
      at Object.connectDB (src/app.js:40:3)
      at Object.require (tests/validation.test.js:2:13)

