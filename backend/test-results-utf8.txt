
> backend@1.0.0 test
> jest --runInBand --detectOpenHandles

node.exe : (node:28972) 
[MONGOOSE] Warning: 
Duplicate schema index 
on {"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
En línea: 1 Carácter: 1
+ & "C:\Program 
Files\nodejs/node.exe" 
"C:\Program 
Files\nodejs/node_mo ...
+ ~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo      
        : NotSpecified  
  : ((node:28972) [M.   
 ..dex definition.:S    
tring) [], RemoteEx    
ception
    + FullyQualifiedErr 
   orId : NativeComman  
  dError
 
(Use `node 
--trace-warnings ...` 
to show where the 
warning was created)
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"numeroPedido":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"expiraEn":1} found. 
This is often due to 
declaring an index 
using both "index: 
true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
[0mPOST /api/auth/login [33m400[0m 17.976 ms - 58[0m
[0mPOST /api/auth/register [33m400[0m 3.260 ms - 58[0m
[0mPOST /api/auth/login [31m500[0m 10018.868 ms - 476[0m
[0mPOST /api/reservas/barberos/invalid-id/reservar [33m400[0m 1.750 ms - 58[0m
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 4.840 ms - 58[0m
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 1.239 ms - 58[0m
[0mPOST /api/barberias/test-slug/admin/servicios [33m401[0m 1.755 ms - 27[0m
FAIL tests/validation.te
st.js (14.954 s)
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] 
injecting env (13) from 
.env -- tip: ÔÜÖ´©Å  
suppress all logs with 
{ quiet: true }

      at _log (node_modu
les/dotenv/lib/main.js:1
42:11)

    console.log
      ƒôí [POST] 
/api/auth/login

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] 
/api/auth/register

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] 
/api/auth/login

      at log 
(src/app.js:90:11)

    console.error
      ƒö┤ ERROR: 
MongooseError: 
Operation 
`users.findOne()` 
buffering timed out 
after 10000ms
          at 
Timeout.<anonymous> (C:\
Users\Kristian\Desktop\b
arber-saas\backend\node_
modules\mongoose\lib\dri
vers\node-mongodb-native
\collection.js:187:23)
          at 
listOnTimeout (node:inte
rnal/timers:588:17)
          at 
processTimers (node:inte
rnal/timers:523:7)

    [0m [90m 4 |[39m
     [90m 5 |[39m 
[36mconst[39m 
errorHandler 
[33m=[39m 
(err[33m,[39m 
req[33m,[39m 
res[33m,[39m next) 
[33m=>[39m {
    [31m[1m>[22m[39m
[90m 6 |[39m   console
[33m.[39merror([32m"
ƒö┤ 
ERROR:"[39m[33m,[39m 
err)[33m;[39m
     [90m   |[39m     
      
[31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   
[90m// ƒöÑ A├æADIR 
HEADERS CORS SI NO 
EXISTEN[39m
     [90m 9 |[39m   
[36mconst[39m origin 
[33m=[39m req[33m.[3
9mheaders[33m.[39morig
in[33m;[39m[0m

      at error (src/conf
ig/middleware/errorHandl
er.js:6:11)
      at 
Layer.handleError (node_
modules/router/lib/layer
.js:116:17)
      at trimPrefix (nod
e_modules/router/index.j
s:340:13)
      at node_modules/ro
uter/index.js:297:9
      at processParams (
node_modules/router/inde
x.js:582:12)
      at next (node_modu
les/router/index.js:291:
5)
      at 
Layer.handleError (node_
modules/router/lib/layer
.js:111:12)
      at trimPrefix (nod
e_modules/router/index.j
s:340:13)
      at node_modules/ro
uter/index.js:297:9
      at processParams (
node_modules/router/inde
x.js:582:12)
      at Immediate.next 
(node_modules/router/ind
ex.js:291:5)
      at 
Immediate._onImmediate (
node_modules/router/inde
x.js:688:15)

    console.log
      ƒôí [POST] /api/re
servas/barberos/invalid-
id/reservar

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/re
servas/barberos/507f1f77
bcf86cd799439011/reserva
r

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/re
servas/barberos/507f1f77
bcf86cd799439011/reserva
r

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/ba
rberias/test-slug/admin/
servicios

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/ba
rberias/test-slug/admin/
servicios

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/res
ervas?barberoId%5B%24ne%
5D

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] 
/api/auth/login

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/re
servas/barberos/507f1f77
bcf86cd799439011/reserva
r

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/re
servas/barberos/507f1f77
bcf86cd799439011/reserva
r

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] 
/api/auth/register

      at log 
(src/app.js:90:11)

  ÔùÅ Input Validation 
Tests ÔÇ║ Auth 
Validation ÔÇ║ should 
reject invalid email 
format

    expect(received).toE
qual(expected) // deep 
equality

    Expected: 
ArrayContaining 
[ObjectContaining 
{"field": "email", 
"message": 
StringContaining 
"Invalid email"}]
    Received: []

    [0m [90m 15 
|[39m             expec
t(res[33m.[39mbody[33
m.[39msuccess)[33m.[3
9mtoBe([36mfalse[39m)
[33m;[39m
     [90m 16 |[39m    
         expect(res[33m
.[39mbody[33m.[39mmes
sage)[33m.[39mtoBe([3
2m'Validation 
error'[39m)[33m;[39m
    [31m[1m>[22m[39m
[90m 17 |[39m         
    expect(res[33m.[39
mbody[33m.[39merrors)
[33m.[39mtoEqual(
     [90m    |[39m    
                        
         
[31m[1m^[22m[39m
     [90m 18 |[39m    
             expect[33m
.[39marrayContaining([
     [90m 19 |[39m    
                 expect
[33m.[39mobjectContaini
ng({
     [90m 20 |[39m    
                     
field[33m:[39m [32m'e
mail'[39m[33m,[39m[0
m

      at Object.toEqual 
(tests/validation.test.j
s:17:37)

  ÔùÅ Input Validation 
Tests ÔÇ║ Auth 
Validation ÔÇ║ should 
reject weak password on 
registration

    expect(received).toB
eGreaterThan(expected)

    Expected: > 0
    Received:   0

    [0m [90m 36 |[39m
     [90m 37 |[39m    
         expect(res[33m
.[39mstatus)[33m.[39m
toBe([35m400[39m)[33m
;[39m
    [31m[1m>[22m[39m
[90m 38 |[39m         
    expect(res[33m.[39
mbody[33m.[39merrors[
33m.[39mlength)[33m.[
39mtoBeGreaterThan([35m
0[39m)[33m;[39m
     [90m    |[39m    
                        
                
[31m[1m^[22m[39m
     [90m 39 |[39m    
     })[33m;[39m
     [90m 40 |[39m
     [90m 41 |[39m    
     it([32m'should 
accept valid login 
data'[39m[33m,[39m 
[36masync[39m () 
[33m=>[39m {[0m

      at 
Object.toBeGreaterThan (
tests/validation.test.js
:38:44)

  ÔùÅ Input Validation 
Tests ÔÇ║ Reserva 
Validation ÔÇ║ should 
reject invalid ObjectId 
format

    expect(received).toE
qual(expected) // deep 
equality

    Expected: 
ArrayContaining 
[ObjectContaining 
{"field": "barberoId", 
"message": 
StringContaining 
"Invalid ObjectId"}]
    Received: []

    [0m [90m 66 |[39m
     [90m 67 |[39m    
         expect(res[33m
.[39mstatus)[33m.[39m
toBe([35m400[39m)[33m
;[39m
    [31m[1m>[22m[39m
[90m 68 |[39m         
    expect(res[33m.[39
mbody[33m.[39merrors)
[33m.[39mtoEqual(
     [90m    |[39m    
                        
         
[31m[1m^[22m[39m
     [90m 69 |[39m    
             expect[33m
.[39marrayContaining([
     [90m 70 |[39m    
                 expect
[33m.[39mobjectContaini
ng({
     [90m 71 |[39m    
                     
field[33m:[39m [32m'b
arberoId'[39m[33m,[39
m[0m

      at Object.toEqual 
(tests/validation.test.j
s:68:37)

  ÔùÅ Input Validation 
Tests ÔÇ║ Reserva 
Validation ÔÇ║ should 
reject past dates

    expect(received).toE
qual(expected) // deep 
equality

    Expected: 
ArrayContaining 
[ObjectContaining 
{"field": "fecha", 
"message": 
StringContaining 
"future"}]
    Received: []

    [0m [90m 89 |[39m
     [90m 90 |[39m    
         expect(res[33m
.[39mstatus)[33m.[39m
toBe([35m400[39m)[33m
;[39m
    [31m[1m>[22m[39m
[90m 91 |[39m         
    expect(res[33m.[39
mbody[33m.[39merrors)
[33m.[39mtoEqual(
     [90m    |[39m    
                        
         
[31m[1m^[22m[39m
     [90m 92 |[39m    
             expect[33m
.[39marrayContaining([
     [90m 93 |[39m    
                 expect
[33m.[39mobjectContaini
ng({
     [90m 94 |[39m    
                     
field[33m:[39m [32m'f
echa'[39m[33m,[39m[0
m

      at Object.toEqual 
(tests/validation.test.j
s:91:37)

  ÔùÅ Input Validation 
Tests ÔÇ║ Servicio 
Validation ÔÇ║ should 
reject negative price

    expect(received).toB
e(expected) // 
Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 125 
|[39m                 
})[33m;[39m
     [90m 126 |[39m
    [31m[1m>[22m[39m
[90m 127 |[39m        
     expect(res[33m.[3
9mstatus)[33m.[39mtoBe
([35m400[39m)[33m;[3
9m
     [90m     |[39m   
                        
     
[31m[1m^[22m[39m
     [90m 128 |[39m   
          expect(res[33
m.[39mbody[33m.[39mer
rors)[33m.[39mtoEqual(
     [90m 129 |[39m   
              expect[33
m.[39marrayContaining([
     [90m 130 |[39m   
                  expect
[33m.[39mobjectContain
ing({[0m

      at Object.toBe (te
sts/validation.test.js:1
27:32)

  ÔùÅ Input Validation 
Tests ÔÇ║ Servicio 
Validation ÔÇ║ should 
reject invalid duration

    expect(received).toB
e(expected) // 
Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 145 
|[39m                 
})[33m;[39m
     [90m 146 |[39m
    [31m[1m>[22m[39m
[90m 147 |[39m        
     expect(res[33m.[3
9mstatus)[33m.[39mtoBe
([35m400[39m)[33m;[3
9m
     [90m     |[39m   
                        
     
[31m[1m^[22m[39m
     [90m 148 |[39m   
      })[33m;[39m
     [90m 149 |[39m   
  })[33m;[39m
     [90m 150 |[39m 
})[33m;[39m[0m

      at Object.toBe (te
sts/validation.test.js:1
47:32)

  ÔùÅ Error Message 
Quality ÔÇ║ should 
provide clear 
field-level errors

    expect(received).toB
eGreaterThan(expected)

    Expected: > 0
    Received:   0

    [0m [90m 220 
|[39m
     [90m 221 |[39m   
      expect(res[33m.[
39mstatus)[33m.[39mtoB
e([35m400[39m)[33m;[
39m
    [31m[1m>[22m[39m
[90m 222 |[39m        
 expect(res[33m.[39mbo
dy[33m.[39merrors[33m
.[39mlength)[33m.[39m
toBeGreaterThan([35m0[
39m)[33m;[39m
     [90m     |[39m   
                        
             
[31m[1m^[22m[39m
     [90m 223 |[39m
     [90m 224 |[39m   
      [90m// Each 
error should have field 
and message[39m
     [90m 225 |[39m   
      res[33m.[39mbody
[33m.[39merrors[33m.
[39mforEach(error 
[33m=>[39m {[0m

      at 
Object.toBeGreaterThan (
tests/validation.test.js
:222:40)

(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"numeroPedido":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"expiraEn":1} found. 
This is often due to 
declaring an index 
using both "index: 
true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
[0mPOST /api/barberias/test-slug/admin/servicios [33m401[0m 0.667 ms - 27[0m
[0mGET /api/reservas?barberoId%5B%24ne%5D [33m401[0m 0.336 ms - 27[0m
[0mPOST /api/auth/login [33m400[0m 2.264 ms - 58[0m
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 0.878 ms - 58[0m
[0mPOST /api/reservas/barberos/507f1f77bcf86cd799439011/reservar [33m400[0m 1.414 ms - 58[0m
[0mPOST /api/auth/register [33m400[0m 1.323 ms - 58[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=001687f97da853d906b7c3bf2cd1106c7f50c4cb9c8d7923c0e66aed00e86913 [32m201[0m 49.125 ms - 646[0m
[0mPOST /api/public/barberia-test/resenas [33m404[0m 7.829 ms - 51[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=invalid-token [33m404[0m 9.549 ms - 51[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=06a02837f30b56c5811ed3afe18d5b2610249ff62329bb9482da8960797d99b0 [32m201[0m 29.286 ms - 611[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=06a02837f30b56c5811ed3afe18d5b2610249ff62329bb9482da8960797d99b0 [31m500[0m 30.930 ms - 55[0m
[0mPOST /api/public/barberia-test/resenas?reviewToken=a92eadb223a779bdd1347102c20ac4af83e15e7e918da413a90fdf8f7b55d562 [31m500[0m 18.257 ms - 55[0m
[0mGET /api/public/barberia-test/resenas/validar-token?reviewToken=058bca3829fefe21eaa29c7c58997b1a29eea60c9e17c09c7c3edf312f1a2b65 [32m200[0m 31.449 ms - 144[0m
[0mGET /api/public/barberia-test/resenas/validar-token?reviewToken=invalid [33m404[0m 5.111 ms - 45[0m
[0mGET /api/public/barberia-test/resenas [32m200[0m 22.015 ms - 849[0m
[0mGET /api/public/barberia-test/resenas [32m200[0m 23.409 ms - 849[0m
[0mGET /api/admin/resenas/pendientes [32m200[0m 14.626 ms - 424[0m
[0mGET /api/admin/resenas/pendientes [33m401[0m 0.473 ms - 27[0m
[0mPATCH /api/admin/resenas/698a8070dcff1759475cccd8/aprobar [32m200[0m 14.012 ms - 448[0m
[0mPATCH /api/admin/resenas/698a8070dcff1759475cccec/aprobar [33m401[0m 0.367 ms - 27[0m
[0mGET /api/admin/resenas/estadisticas [32m200[0m 9.912 ms - 91[0m
[0mGET /api/public/barberia-test/resenas [32m200[0m 21.729 ms - 464[0m
FAIL 
tests/resenas.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] 
injecting env (13) from 
.env -- tip: ƒöÉ 
encrypt with Dotenvx: 
https://dotenvx.com

      at _log (node_modu
les/dotenv/lib/main.js:1
42:11)

    console.log
      ƒôí [POST] /api/pu
blic/barberia-test/resen
as?reviewToken=001687f97
da853d906b7c3bf2cd1106c7
f50c4cb9c8d7923c0e66aed0
0e86913

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/pu
blic/barberia-test/resen
as

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/pu
blic/barberia-test/resen
as?reviewToken=invalid-t
oken

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/pu
blic/barberia-test/resen
as?reviewToken=06a02837f
30b56c5811ed3afe18d5b261
0249ff62329bb9482da89607
97d99b0

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/pu
blic/barberia-test/resen
as?reviewToken=06a02837f
30b56c5811ed3afe18d5b261
0249ff62329bb9482da89607
97d99b0

      at log 
(src/app.js:90:11)

    console.error
      Error al crear 
rese├▒a: 
MongoServerError: 
E11000 duplicate key 
error collection: barber
-saas-test.resenas 
index: reservaId_1 dup 
key: { reservaId: Object
Id('698a806fdcff1759475c
cc24') }
          at InsertOneOp
eration.handleOk (C:\Use
rs\Kristian\Desktop\barb
er-saas\backend\node_mod
ules\mongodb\src\operati
ons\insert.ts:79:13)
          at 
tryOperation (C:\Users\K
ristian\Desktop\barber-s
aas\backend\node_modules
\mongodb\src\operations\
execute_operation.ts:294
:26)
          at processTick
sAndRejections (node:int
ernal/process/task_queue
s:105:5)
          at 
executeOperation (C:\Use
rs\Kristian\Desktop\barb
er-saas\backend\node_mod
ules\mongodb\src\operati
ons\execute_operation.ts
:123:12)
          at 
Collection.insertOne (C:
\Users\Kristian\Desktop\
barber-saas\backend\node
_modules\mongodb\src\col
lection.ts:294:12)
          at 
model.$__save (C:\Users\
Kristian\Desktop\barber-
saas\backend\node_module
s\mongoose\lib\model.js:
398:16)
          at model.save 
(C:\Users\Kristian\Deskt
op\barber-saas\backend\n
ode_modules\mongoose\lib
\model.js:609:5)
          at Object.<ano
nymous>.exports.crearRes
ena (C:\Users\Kristian\D
esktop\barber-saas\backe
nd\src\controllers\resen
as.controller.js:96:9) {
        errorLabelSet: 
Set(0) {},
        errorResponse: {
          index: 0,
          code: 11000,
          errmsg: 
"E11000 duplicate key 
error collection: barber
-saas-test.resenas 
index: reservaId_1 dup 
key: { reservaId: Object
Id('698a806fdcff1759475c
cc24') }",
          keyPattern: { 
reservaId: 1 },
          keyValue: { 
reservaId: new ObjectId(
'698a806fdcff1759475ccc2
4') }
        },
        index: 0,
        code: 11000,
        keyPattern: { 
reservaId: 1 },
        keyValue: { 
reservaId: new ObjectId(
'698a806fdcff1759475ccc2
4') }
      }

    [0m [90m 106 
|[39m         
})[33m;[39m
     [90m 107 |[39m   
  } [36mcatch[39m 
(error) {
    [31m[1m>[22m[39m
[90m 108 |[39m        
 console[33m.[39merror
([32m"Error al crear re
se├▒a:"[39m[33m,[39m 
error)[33m;[39m
     [90m     |[39m   
              
[31m[1m^[22m[39m
     [90m 109 |[39m   
      res[33m.[39mstat
us([35m500[39m)[33m.
[39mjson({ 
success[33m:[39m [36m
false[39m[33m,[39m 
message[33m:[39m 
[32m"Error al crear la 
rese├▒a"[39m 
})[33m;[39m
     [90m 110 |[39m   
  }
     [90m 111 |[39m 
}[33m;[39m[0m

      at error (src/cont
rollers/resenas.controll
er.js:108:17)

    console.log
      ƒôí [POST] /api/pu
blic/barberia-test/resen
as?reviewToken=a92eadb22
3a779bdd1347102c20ac4af8
3e15e7e918da413a90fdf8f7
b55d562

      at log 
(src/app.js:90:11)

    console.error
      Error al crear 
rese├▒a: 
ValidationError: Resena 
validation failed: 
calificacionGeneral: 
Path 
`calificacionGeneral` 
is required.
          at model.Objec
t.<anonymous>.Document.i
nvalidate (C:\Users\Kris
tian\Desktop\barber-saas
\backend\node_modules\mo
ngoose\lib\document.js:3
370:32)
          at 
validatePath (C:\Users\K
ristian\Desktop\barber-s
aas\backend\node_modules
\mongoose\lib\document.j
s:3145:13)
          at processTick
sAndRejections (node:int
ernal/process/task_queue
s:105:5)
          at async 
Promise.all (index 5)
          at 
model.$__validate (C:\Us
ers\Kristian\Desktop\bar
ber-saas\backend\node_mo
dules\mongoose\lib\docum
ent.js:3086:3)
          at 
model.validate (C:\Users
\Kristian\Desktop\barber
-saas\backend\node_modul
es\mongoose\lib\document
.js:2663:5)
          at model.valid
ateBeforeSave (C:\Users\
Kristian\Desktop\barber-
saas\backend\node_module
s\mongoose\lib\plugins\v
alidateBeforeSave.js:34:
7)
          at 
Kareem.execPre (C:\Users
\Kristian\Desktop\barber
-saas\backend\node_modul
es\kareem\index.js:65:24
)
          at 
model.$__save (C:\Users\
Kristian\Desktop\barber-
saas\backend\node_module
s\mongoose\lib\model.js:
369:5)
          at model.save 
(C:\Users\Kristian\Deskt
op\barber-saas\backend\n
ode_modules\mongoose\lib
\model.js:609:5)
          at Object.<ano
nymous>.exports.crearRes
ena (C:\Users\Kristian\D
esktop\barber-saas\backe
nd\src\controllers\resen
as.controller.js:96:9) {
        errors: {
          
calificacionGeneral: 
ValidatorError: Path 
`calificacionGeneral` 
is required.
              at 
SchemaNumber.doValidate 
(C:\Users\Kristian\Deskt
op\barber-saas\backend\n
ode_modules\mongoose\lib
\schemaType.js:1425:13)
              at 
validatePath (C:\Users\K
ristian\Desktop\barber-s
aas\backend\node_modules
\mongoose\lib\document.j
s:3137:24)
              at 
model.$__validate (C:\Us
ers\Kristian\Desktop\bar
ber-saas\backend\node_mo
dules\mongoose\lib\docum
ent.js:3083:21)
              at process
TicksAndRejections (node
:internal/process/task_q
ueues:105:5)
              at 
model.validate (C:\Users
\Kristian\Desktop\barber
-saas\backend\node_modul
es\mongoose\lib\document
.js:2663:5)
              at model.v
alidateBeforeSave (C:\Us
ers\Kristian\Desktop\bar
ber-saas\backend\node_mo
dules\mongoose\lib\plugi
ns\validateBeforeSave.js
:34:7)
              at 
Kareem.execPre (C:\Users
\Kristian\Desktop\barber
-saas\backend\node_modul
es\kareem\index.js:65:24
)
              at 
model.$__save (C:\Users\
Kristian\Desktop\barber-
saas\backend\node_module
s\mongoose\lib\model.js:
369:5)
              at 
model.save (C:\Users\Kri
stian\Desktop\barber-saa
s\backend\node_modules\m
ongoose\lib\model.js:609
:5)
              at Object.
<anonymous>.exports.crea
rResena (C:\Users\Kristi
an\Desktop\barber-saas\b
ackend\src\controllers\r
esenas.controller.js:96:
9) {
            properties: 
[Object],
            kind: 
'required',
            path: 
'calificacionGeneral',
            value: 
undefined,
            reason: 
undefined,
            [Symbol(mong
oose#validatorError)]: 
true
          }
        },
        _message: 
'Resena validation 
failed'
      }

    [0m [90m 106 
|[39m         
})[33m;[39m
     [90m 107 |[39m   
  } [36mcatch[39m 
(error) {
    [31m[1m>[22m[39m
[90m 108 |[39m        
 console[33m.[39merror
([32m"Error al crear re
se├▒a:"[39m[33m,[39m 
error)[33m;[39m
     [90m     |[39m   
              
[31m[1m^[22m[39m
     [90m 109 |[39m   
      res[33m.[39mstat
us([35m500[39m)[33m.
[39mjson({ 
success[33m:[39m [36m
false[39m[33m,[39m 
message[33m:[39m 
[32m"Error al crear la 
rese├▒a"[39m 
})[33m;[39m
     [90m 110 |[39m   
  }
     [90m 111 |[39m 
}[33m;[39m[0m

      at error (src/cont
rollers/resenas.controll
er.js:108:17)

    console.log
      ƒôí [GET] /api/pub
lic/barberia-test/resena
s/validar-token?reviewTo
ken=058bca3829fefe21eaa2
9c7c58997b1a29eea60c9e17
c09c7c3edf312f1a2b65

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/pub
lic/barberia-test/resena
s/validar-token?reviewTo
ken=invalid

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/pub
lic/barberia-test/resena
s

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/pub
lic/barberia-test/resena
s

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/adm
in/resenas/pendientes

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/adm
in/resenas/pendientes

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [PATCH] /api/a
dmin/resenas/698a8070dcf
f1759475cccd8/aprobar

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [PATCH] /api/a
dmin/resenas/698a8070dcf
f1759475cccec/aprobar

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/adm
in/resenas/estadisticas

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/pub
lic/barberia-test/resena
s

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [GET] /api/pub
lic/barberia-2/resenas

      at log 
(src/app.js:90:11)

  ÔùÅ Sistema de 
Rese├▒as - Tests ÔÇ║ 
GET /api/public/:slug/re
senas/validar-token - 
Validar Token ÔÇ║ Debe 
validar token correcto

    expect(received).toB
e(expected) // 
Object.is equality

    Expected: true
    Received: undefined

    [0m [90m 179 
|[39m
     [90m 180 |[39m   
          expect(respons
e[33m.[39mstatus)[33m
.[39mtoBe([35m200[39m
)[33m;[39m
    [31m[1m>[22m[39m
[90m 181 |[39m        
     expect(response[33
m.[39mbody[33m.[39mva
lido)[33m.[39mtoBe([3
6mtrue[39m)[33m;[39m
     [90m     |[39m   
                        
               
[31m[1m^[22m[39m
     [90m 182 |[39m   
      })[33m;[39m
     [90m 183 |[39m
     [90m 184 |[39m   
      test([32m'Debe 
rechazar token inv├ílido
'[39m[33m,[39m 
[36masync[39m () 
[33m=>[39m {[0m

      at Object.toBe (te
sts/resenas.test.js:181:
42)

  ÔùÅ Sistema de 
Rese├▒as - Tests ÔÇ║ 
GET /api/public/:slug/re
senas/validar-token - 
Validar Token ÔÇ║ Debe 
rechazar token inv├ílido

    expect(received).toB
e(expected) // 
Object.is equality

    Expected: false
    Received: undefined

    [0m [90m 187 
|[39m
     [90m 188 |[39m   
          expect(respons
e[33m.[39mstatus)[33m
.[39mtoBe([35m404[39m
)[33m;[39m
    [31m[1m>[22m[39m
[90m 189 |[39m        
     expect(response[33
m.[39mbody[33m.[39mva
lido)[33m.[39mtoBe([3
6mfalse[39m)[33m;[39m
     [90m     |[39m   
                        
               
[31m[1m^[22m[39m
     [90m 190 |[39m   
      })[33m;[39m
     [90m 191 |[39m   
  })[33m;[39m
     [90m 192 
|[39m[0m

      at Object.toBe (te
sts/resenas.test.js:189:
42)

  ÔùÅ Sistema de 
Rese├▒as - Tests ÔÇ║ 
GET /api/public/:slug/re
senas - Listar Rese├▒as 
P├║blicas ÔÇ║ Debe 
calcular promedio 
correctamente

    expect(received).toB
e(expected) // 
Object.is equality

    Expected: 4.5
    Received: undefined

    [0m [90m 242 
|[39m
     [90m 243 |[39m   
          expect(respons
e[33m.[39mstatus)[33m
.[39mtoBe([35m200[39m
)[33m;[39m
    [31m[1m>[22m[39m
[90m 244 |[39m        
     expect(response[33
m.[39mbody[33m.[39mda
ta[33m.[39mpromedio)[
33m.[39mtoBe([35m4.5[
39m)[33m;[39m [90m// 
(5+4)/2[39m
     [90m     |[39m   
                        
                      
[31m[1m^[22m[39m
     [90m 245 |[39m   
      })[33m;[39m
     [90m 246 |[39m   
  })[33m;[39m
     [90m 247 
|[39m[0m

      at Object.toBe (te
sts/resenas.test.js:244:
49)

  ÔùÅ Sistema de 
Rese├▒as - Tests ÔÇ║ 
GET /api/admin/resenas/e
stadisticas - 
Estad├¡sticas ÔÇ║ Debe 
retornar estad├¡sticas 
correctas

    expect(received).toB
eDefined()

    Received: undefined

    [0m [90m 349 
|[39m             expec
t(response[33m.[39mbod
y[33m.[39mdata[33m.[
39mtotal)[33m.[39mtoBe
([35m2[39m)[33m;[39m
     [90m 350 |[39m   
          expect(respons
e[33m.[39mbody[33m.[
39mdata[33m.[39mpromed
io)[33m.[39mtoBe([35m
4.5[39m)[33m;[39m
    [31m[1m>[22m[39m
[90m 351 |[39m        
     expect(response[33
m.[39mbody[33m.[39mda
ta[33m.[39mporCalifica
cion)[33m.[39mtoBeDefi
ned()[33m;[39m
     [90m     |[39m   
                        
                        
     
[31m[1m^[22m[39m
     [90m 352 |[39m   
      })[33m;[39m
     [90m 353 |[39m   
  })[33m;[39m
     [90m 354 
|[39m[0m

      at 
Object.toBeDefined (test
s/resenas.test.js:351:56
)

(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"numeroPedido":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"expiraEn":1} found. 
This is often due to 
declaring an index 
using both "index: 
true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
[0mGET /api/public/barberia-2/resenas [32m200[0m 15.031 ms - 461[0m
[0mPOST /api/public/atomic-shop/barberos/698a8072f0027a501dda1b99/reservar [33m404[0m 9.202 ms - 205[0m
[0mPOST /api/public/atomic-shop/barberos/698a8072f0027a501dda1b99/reservar [33m404[0m 7.886 ms - 205[0m
FAIL tests/reservas_atom
icas.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] 
injecting env (13) from 
.env -- tip: ƒôí add 
observability to 
secrets: 
https://dotenvx.com/ops

      at _log (node_modu
les/dotenv/lib/main.js:1
42:11)

    console.log
      ƒôí [POST] /api/pu
blic/atomic-shop/barbero
s/698a8072f0027a501dda1b
99/reservar

      at log 
(src/app.js:90:11)

    console.log
      ƒôí [POST] /api/pu
blic/atomic-shop/barbero
s/698a8072f0027a501dda1b
99/reservar

      at log 
(src/app.js:90:11)

  ÔùÅ Pruebas de 
Atomicidad de Reservas 
(Anti-Overbooking) ÔÇ║ 
No debe permitir dos 
reservas en el mismo 
horario (Previene 
Overbooking)

    expect(received).toB
e(expected) // 
Object.is equality

    Expected: 201
    Received: 404

    [0m [90m 63 
|[39m             [33m
.[39msend(payload)[33m
;[39m
     [90m 64 |[39m
    [31m[1m>[22m[39m
[90m 65 |[39m         
expect(res1[33m.[39mst
atus)[33m.[39mtoBe([3
5m201[39m)[33m;[39m
     [90m    |[39m    
                        
 [31m[1m^[22m[39m
     [90m 66 |[39m    
     expect(res1[33m.[
39mbody[33m.[39mmessag
e)[33m.[39mtoContain(
[32m'correctamente'[39m
)[33m;[39m
     [90m 67 |[39m
     [90m 68 |[39m    
     [90m// 2. 
Intentar crear 
exactamente la misma 
reserva[39m[0m

      at Object.toBe (te
sts/reservas_atomicas.te
st.js:65:29)

  ÔùÅ Pruebas de 
Atomicidad de Reservas 
(Anti-Overbooking) ÔÇ║ 
Debe permitir reservar 
si la cita anterior fue 
CANCELADA

    TypeError: Cannot 
read properties of 
undefined (reading 
'_id')

    [0m [90m  99 
|[39m             [33m
.[39msend(payload)[33m
;[39m
     [90m 100 |[39m
    [31m[1m>[22m[39m
[90m 101 |[39m        
 [36mconst[39m 
reservaId [33m=[39m re
s1[33m.[39mbody[33m.
[39mreserva[33m.[39m_i
d[33m;[39m
     [90m     |[39m   
                        
                  
[31m[1m^[22m[39m
     [90m 102 |[39m
     [90m 103 |[39m   
      [90m// 2. 
Cancelar la reserva[39m
     [90m 104 |[39m   
      [36mawait[39m [
33mReserva[39m[33m.[3
9mfindByIdAndUpdate(rese
rvaId[33m,[39m { 
estado[33m:[39m 
[32m'CANCELADA'[39m 
})[33m;[39m[0m

      at Object._id (tes
ts/reservas_atomicas.tes
t.js:101:45)

(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"numeroPedido":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"expiraEn":1} found. 
This is often due to 
declaring an index 
using both "index: 
true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
FAIL tests/multi-tenant-
security.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] 
injecting env (13) from 
.env -- tip: ƒöæ add 
access controls to 
secrets: 
https://dotenvx.com/ops

      at _log (node_modu
les/dotenv/lib/main.js:1
42:11)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Reservas - Cross-Tenant 
Access Prevention ÔÇ║ 
Admin A NO puede ver 
reserva de Barber├¡a B

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Reservas - Cross-Tenant 
Access Prevention ÔÇ║ 
Admin A NO puede editar 
reserva de Barber├¡a B

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Reservas - Cross-Tenant 
Access Prevention ÔÇ║ 
Admin A NO puede 
cancelar reserva de 
Barber├¡a B

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Reservas - Cross-Tenant 
Access Prevention ÔÇ║ 
Admin A solo ve sus 
propias reservas al 
listar

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Servicios - 
Cross-Tenant Access 
Prevention ÔÇ║ Admin A 
NO puede acceder a 
servicios de Barber├¡a 
B v├¡a slug

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Servicios - 
Cross-Tenant Access 
Prevention ÔÇ║ Admin A 
NO puede crear servicio 
en Barber├¡a B

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Servicios - 
Cross-Tenant Access 
Prevention ÔÇ║ Admin A 
NO puede editar 
servicio de Barber├¡a B

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Barberos - Cross-Tenant 
Access Prevention ÔÇ║ 
Admin A NO puede ver 
barberos de Barber├¡a B

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒÜ½ 
Barberos - Cross-Tenant 
Access Prevention ÔÇ║ 
Admin A NO puede crear 
barbero en Barber├¡a B

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒöÆ 
URL Slug Manipulation 
Attempts ÔÇ║ Rechaza 
intento de acceder con 
slug incorrecto

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒöÆ 
URL Slug Manipulation 
Attempts ÔÇ║ Rechaza 
slug inexistente

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒöÆ 
Query Parameter 
Injection Prevention 
ÔÇ║ Ignora barberiaId 
inyectado en query 
params

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒöÆ 
Query Parameter 
Injection Prevention 
ÔÇ║ Ignora barberiaId 
inyectado en request 
body

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ Ô£à 
Legitimate Access 
Allowed ÔÇ║ Admin A 
puede ver sus propias 
reservas

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ Ô£à 
Legitimate Access 
Allowed ÔÇ║ Admin A 
puede acceder a sus 
servicios

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ Ô£à 
Legitimate Access 
Allowed ÔÇ║ Admin B 
puede acceder a sus 
propios datos

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒöì 
Logging and Monitoring 
ÔÇ║ Loguea intentos de 
acceso cross-tenant

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)

  ÔùÅ ƒöÉ Multi-Tenant 
Security Tests ÔÇ║ ƒææ 
SUPERADMIN Access ÔÇ║ 
SUPERADMIN puede 
acceder a cualquier 
barber├¡a

    TypeError: 
connectDB is not a 
function

    [0m [90m 18 |[39m
     [90m 19 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 20 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 21 |[39m    
 })[33m;[39m
     [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
multi-tenant-security.te
st.js:20:15)


  ÔùÅ Test suite failed 
to run

    TypeError: closeDB 
is not a function

    [0m [90m 22 |[39m
     [90m 23 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 24 |[39m         
[36mawait[39m 
closeDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 25 |[39m    
 })[33m;[39m
     [90m 26 |[39m
     [90m 27 |[39m    
 beforeEach([36masync[
39m () [33m=>[39m 
{[0m

      at Object.closeDB 
(tests/multi-tenant-secu
rity.test.js:24:15)

(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"numeroPedido":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"expiraEn":1} found. 
This is often due to 
declaring an index 
using both "index: 
true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
FAIL tests/race-conditio
n-stress.test.js
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] 
injecting env (13) from 
.env -- tip: ƒùé´©Å 
backup and recover 
secrets: 
https://dotenvx.com/ops

      at _log (node_modu
les/dotenv/lib/main.js:1
42:11)

  ÔùÅ ƒöÑ Race 
Condition Stress Tests 
ÔÇ║ Concurrencia 
Extrema ÔÇ║ 10 requests 
simult├íneos al mismo 
horario - solo 1 debe 
tener ├®xito

    TypeError: 
connectDB is not a 
function

    [0m [90m 16 |[39m
     [90m 17 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 18 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 19 |[39m    
 })[33m;[39m
     [90m 20 |[39m
     [90m 21 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
race-condition-stress.te
st.js:18:15)

  ÔùÅ ƒöÑ Race 
Condition Stress Tests 
ÔÇ║ Concurrencia 
Extrema ÔÇ║ 50 requests 
simult├íneos - solo 1 
debe tener ├®xito

    TypeError: 
connectDB is not a 
function

    [0m [90m 16 |[39m
     [90m 17 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 18 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 19 |[39m    
 })[33m;[39m
     [90m 20 |[39m
     [90m 21 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
race-condition-stress.te
st.js:18:15)

  ÔùÅ ƒöÑ Race 
Condition Stress Tests 
ÔÇ║ ├ìndice ├Ünico - 
Validaci├│n Directa ÔÇ║ 
├ìndice ├║nico previene 
duplicados en DB

    TypeError: 
connectDB is not a 
function

    [0m [90m 16 |[39m
     [90m 17 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 18 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 19 |[39m    
 })[33m;[39m
     [90m 20 |[39m
     [90m 21 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
race-condition-stress.te
st.js:18:15)

  ÔùÅ ƒöÑ Race 
Condition Stress Tests 
ÔÇ║ ├ìndice ├Ünico - 
Validaci├│n Directa ÔÇ║ 
Permite re-usar horario 
si reserva anterior fue 
cancelada

    TypeError: 
connectDB is not a 
function

    [0m [90m 16 |[39m
     [90m 17 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 18 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 19 |[39m    
 })[33m;[39m
     [90m 20 |[39m
     [90m 21 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
race-condition-stress.te
st.js:18:15)

  ÔùÅ ƒöÑ Race 
Condition Stress Tests 
ÔÇ║ Validaci├│n de 
Transacciones ÔÇ║ 
Rollback autom├ítico si 
falla despu├®s de crear 
reserva

    TypeError: 
connectDB is not a 
function

    [0m [90m 16 |[39m
     [90m 17 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 18 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 19 |[39m    
 })[33m;[39m
     [90m 20 |[39m
     [90m 21 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
race-condition-stress.te
st.js:18:15)

  ÔùÅ ƒöÑ Race 
Condition Stress Tests 
ÔÇ║ Performance bajo 
carga ÔÇ║ Maneja 20 
reservas diferentes 
simult├íneas sin 
problemas

    TypeError: 
connectDB is not a 
function

    [0m [90m 16 |[39m
     [90m 17 |[39m    
 beforeAll([36masync[3
9m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 18 |[39m         
[36mawait[39m 
connectDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 19 |[39m    
 })[33m;[39m
     [90m 20 |[39m
     [90m 21 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {[0m

      at 
Object.connectDB (tests/
race-condition-stress.te
st.js:18:15)


  ÔùÅ Test suite failed 
to run

    TypeError: closeDB 
is not a function

    [0m [90m 20 |[39m
     [90m 21 |[39m    
 afterAll([36masync[39
m () [33m=>[39m {
    [31m[1m>[22m[39m
[90m 22 |[39m         
[36mawait[39m 
closeDB()[33m;[39m
     [90m    |[39m    
           
[31m[1m^[22m[39m
     [90m 23 |[39m    
 })[33m;[39m
     [90m 24 |[39m
     [90m 25 |[39m    
 beforeEach([36masync[
39m () [33m=>[39m 
{[0m

      at Object.closeDB 
(tests/race-condition-st
ress.test.js:22:15)

(node:28972) [MONGOOSE] 
Warning: Duplicate 
schema index on 
{"reviewToken":1} 
found. This is often 
due to declaring an 
index using both 
"index: true" and 
"schema.index()". 
Please remove the 
duplicate index 
definition.
FAIL tests/transaction-r
ollback.test.js
  ÔùÅ Transaction 
Rollback Integration 
Tests ÔÇ║ 
CompleteReserva 
Transaction Rollback 
ÔÇ║ should rollback 
reservation update if 
client update fails

    ValidationError: 
User validation failed: 
rol: Path `rol` is 
required., password: 
Path `password` is 
required.

    [0m [90m 59 |[39m
     [90m 60 |[39m    
         [90m// 2. 
Create test client[39m
    [31m[1m>[22m[39m
[90m 61 |[39m         
    [36mconst[39m 
cliente [33m=[39m 
[36mawait[39m [33mUse
rModel[39m[33m.[39mcr
eate({
     [90m    |[39m    
                        
 [31m[1m^[22m[39m
     [90m 62 |[39m    
             
nombre[33m:[39m 
[32m'Test 
Cliente'[39m[33m,[39m
     [90m 63 |[39m    
             
email[33m:[39m [32m't
est@example.com'[39m[3
3m,[39m
     [90m 64 |[39m    
             
barberiaId[33m:[39m te
stBarberiaId[33m,[39m
[0m

      at model.Object.<a
nonymous>.Document.inval
idate (node_modules/mong
oose/lib/document.js:337
0:32)
      at validatePath (n
ode_modules/mongoose/lib
/document.js:3145:13)
          at async 
Promise.all (index 0)
      at 
model.$__validate (node_
modules/mongoose/lib/doc
ument.js:3086:3)
      at model.validate 
(node_modules/mongoose/l
ib/document.js:2663:5)
      at model.validateB
eforeSave (node_modules/
mongoose/lib/plugins/val
idateBeforeSave.js:34:7)
      at Kareem.execPre 
(node_modules/kareem/ind
ex.js:65:24)
      at model.$__save (
node_modules/mongoose/li
b/model.js:369:5)
      at model.save (nod
e_modules/mongoose/lib/m
odel.js:609:5)
      at node_modules/mo
ngoose/lib/model.js:2722
:9
          at async 
Promise.all (index 0)
      at 
Function.create (node_mo
dules/mongoose/lib/model
.js:2707:11)
      at 
Object.<anonymous> (test
s/transaction-rollback.t
est.js:61:29)

  ÔùÅ Transaction 
Rollback Integration 
Tests ÔÇ║ 
CompleteReserva 
Transaction Rollback 
ÔÇ║ should commit both 
updates when successful

    ValidationError: 
User validation failed: 
rol: Path `rol` is 
required., password: 
Path `password` is 
required.

    [0m [90m 116 
|[39m
     [90m 117 |[39m   
          [90m// 2. 
Create test client[39m
    [31m[1m>[22m[39m
[90m 118 |[39m        
     [36mconst[39m 
cliente [33m=[39m 
[36mawait[39m [33mUse
rModel[39m[33m.[39mcr
eate({
     [90m     |[39m   
                        
  [31m[1m^[22m[39m
     [90m 119 |[39m   
              
_id[33m:[39m reserva[
33m.[39mclienteId[33m,
[39m
     [90m 120 |[39m   
              
nombre[33m:[39m 
[32m'Test Cliente 
Success'[39m[33m,[39m
     [90m 121 |[39m   
              
email[33m:[39m [32m's
uccess@example.com'[39m
[33m,[39m[0m

      at model.Object.<a
nonymous>.Document.inval
idate (node_modules/mong
oose/lib/document.js:337
0:32)
      at validatePath (n
ode_modules/mongoose/lib
/document.js:3145:13)
          at async 
Promise.all (index 0)
      at 
model.$__validate (node_
modules/mongoose/lib/doc
ument.js:3086:3)
      at model.validate 
(node_modules/mongoose/l
ib/document.js:2663:5)
      at model.validateB
eforeSave (node_modules/
mongoose/lib/plugins/val
idateBeforeSave.js:34:7)
      at Kareem.execPre 
(node_modules/kareem/ind
ex.js:65:24)
      at model.$__save (
node_modules/mongoose/li
b/model.js:369:5)
      at model.save (nod
e_modules/mongoose/lib/m
odel.js:609:5)
      at node_modules/mo
ngoose/lib/model.js:2722
:9
          at async 
Promise.all (index 0)
      at 
Function.create (node_mo
dules/mongoose/lib/model
.js:2707:11)
      at 
Object.<anonymous> (test
s/transaction-rollback.t
est.js:118:29)

PASS tests/transactions.
test.js
  ÔùÅ Console

    console.log
      [Transaction] 
Started: TestSuccessfulT
ransaction (attempt 1/3)

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:54:25)

    console.log
      [Transaction] 
Committed: TestSuccessfu
lTransaction

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:61:25)

    console.log
      [Transaction] 
Started: TestRollback 
(attempt 1/3)

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:54:25)

    console.log
      [Transaction] 
Aborted: TestRollback

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:69:29)

    console.error
      [Transaction] 
Failed: TestRollback {
        error: 
'Simulated error',
        attempt: 1,
        stack: 'Error: 
Simulated error\n' +
          '    at Transa
ctionManager.executeInTr
ansaction.operationName 
(C:\\Users\\Kristian\\De
sktop\\barber-saas\\back
end\\tests\\transactions
.test.js:34:31)\n' +
          '    at 
Function.operation [as 
executeInTransaction] (C
:\\Users\\Kristian\\Desk
top\\barber-saas\\backen
d\\src\\utils\\Transacti
onManager.js:57:38)\n' +
          '    at proces
sTicksAndRejections (nod
e:internal/process/task_
queues:105:5)\n' +
          '    at 
Object.<anonymous> (C:\\
Users\\Kristian\\Desktop
\\barber-saas\\backend\\
tests\\transactions.test
.js:31:13)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m    
             [90m// 
Non-transient error or 
max retries reached[39m
    [31m[1m>[22m[39m
[90m 82 |[39m         
        console[33m.[3
9merror([32m`[Transacti
on] Failed: ${operationN
ame}`[39m[33m,[39m {
     [90m    |[39m    
                     
[31m[1m^[22m[39m
     [90m 83 |[39m    
                 
error[33m:[39m error[
33m.[39mmessage[33m,[
39m
     [90m 84 |[39m    
                 
attempt[33m:[39m 
attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m    
                 
stack[33m:[39m error[
33m.[39mstack[0m

      at Function.error 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:82:25)
      at 
Object.<anonymous> (test
s/transactions.test.js:3
1:13)

    console.log
      [Transaction] 
Started: TestRetry 
(attempt 1/3)

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:54:25)

    console.log
      [Transaction] 
Aborted: TestRetry

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:69:29)

    console.warn
      [Transaction] 
Transient error, 
retrying in 200ms: 
WriteConflict

    [0m [90m 74 
|[39m                  
   attempt[33m++[39m[
33m;[39m
     [90m 75 |[39m    
                 
[36mconst[39m delay 
[33m=[39m retryDelay 
[33m*[39m [33mMath[3
9m[33m.[39mpow([35m2
[39m[33m,[39m 
attempt)[33m;[39m 
[90m// Exponential 
backoff[39m
    [31m[1m>[22m[39m
[90m 76 |[39m         
            console[33m
.[39mwarn([32m`[Transa
ction] Transient error, 
retrying in ${delay}ms:`
[39m[33m,[39m error[
33m.[39mmessage)[33m;
[39m
     [90m    |[39m    
                        
 [31m[1m^[22m[39m
     [90m 77 |[39m    
                 
[36mawait[39m [36mthi
s[39m[33m.[39msleep(d
elay)[33m;[39m
     [90m 78 |[39m    
                 [36mco
ntinue[39m[33m;[39m
     [90m 79 |[39m    
             }[0m

      at Function.warn 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:76:29)
      at 
Object.<anonymous> (test
s/transactions.test.js:4
4:28)

    console.log
      [Transaction] 
Started: TestRetry 
(attempt 2/3)

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:54:25)

    console.log
      [Transaction] 
Committed: TestRetry

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:61:25)

    console.log
      [Transaction] 
Started: TestNoRetry 
(attempt 1/3)

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:54:25)

    console.log
      [Transaction] 
Aborted: TestNoRetry

      at Function.log 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:69:29)

    console.error
      [Transaction] 
Failed: TestNoRetry {
        error: 'Reserva 
no encontrada',
        attempt: 1,
        stack: 'Error: 
Reserva no 
encontrada\n' +
          '    at Transa
ctionManager.executeInTr
ansaction.operationName 
(C:\\Users\\Kristian\\De
sktop\\barber-saas\\back
end\\tests\\transactions
.test.js:69:31)\n' +
          '    at 
Function.operation [as 
executeInTransaction] (C
:\\Users\\Kristian\\Desk
top\\barber-saas\\backen
d\\src\\utils\\Transacti
onManager.js:57:38)\n' +
          '    at 
Object.<anonymous> (C:\\
Users\\Kristian\\Desktop
\\barber-saas\\backend\\
tests\\transactions.test
.js:65:13)'
      }

    [0m [90m 80 |[39m
     [90m 81 |[39m    
             [90m// 
Non-transient error or 
max retries reached[39m
    [31m[1m>[22m[39m
[90m 82 |[39m         
        console[33m.[3
9merror([32m`[Transacti
on] Failed: ${operationN
ame}`[39m[33m,[39m {
     [90m    |[39m    
                     
[31m[1m^[22m[39m
     [90m 83 |[39m    
                 
error[33m:[39m error[
33m.[39mmessage[33m,[
39m
     [90m 84 |[39m    
                 
attempt[33m:[39m 
attempt [33m+[39m 
[35m1[39m[33m,[39m
     [90m 85 |[39m    
                 
stack[33m:[39m error[
33m.[39mstack[0m

      at Function.error 
[as 
executeInTransaction] (s
rc/utils/TransactionMana
ger.js:82:25)
      at 
Object.<anonymous> (test
s/transactions.test.js:6
5:13)

    console.log
      Ô£à MongoDB 
transactions are 
supported

      at Function.log 
[as validateTransactionS
upport] (src/utils/Trans
actionManager.js:185:21)

PASS 
tests/revenue.test.js

Test Suites: 6 failed, 
2 passed, 8 total
Tests:       39 failed, 
35 passed, 74 total
Snapshots:   0 total
Time:        25.93 s
Ran all test suites.
